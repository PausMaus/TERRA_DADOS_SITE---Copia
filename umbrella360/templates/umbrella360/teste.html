{% load static %}
<link rel="stylesheet" href="{% static 'umbrella360/style.css' %}?v=9">
<link rel="stylesheet" href="{% static 'umbrella360/style_refatorado.css' %}?v=2">
<link rel="stylesheet" href="{% static 'umbrella360/report_novo.css' %}?v=1">



<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Dashboard {{ empresa_logada.nome }} - Umbrella360{% endblock %}</title>
    
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="{% static 'umbrella360/theme-toggle.js' %}?v=2"></script>
  </head>
  <body>
    <!-- Bot√£o de altern√¢ncia de tema -->
    <button id="theme-toggle" class="theme-toggle" title="Alternar tema">
      <span class="theme-icon">‚óê</span> Noite de Ver√£o
    </button>
    
    <!-- Bot√£o de filtros flutuante -->
    <button id="filters-toggle" class="filters-toggle" title="Abrir filtros">
      <span class="filters-icon">‚öô</span> Filtros
    </button>
    
    <!-- Painel de filtros flutuante -->
    <div id="filters-panel" class="filters-panel">
      <div class="filters-header">
        <h4>Filtros Dashboard - {{ empresa_logada.nome }}</h4>
        <button id="close-filters" class="close-filters" title="Fechar filtros">&times;</button>
      </div>
      
      <form method="get" class="filters-form">
        <!-- Empresa √© fixa para a empresa logada -->
        <input type="hidden" name="empresa" value="{{ empresa_logada.id }}">
        
        <div class="filter-group">
          <label for="marca">Marca:</label>
          <select name="marca" id="marca">
            <option value="todas" {% if marca_selecionada == 'todas' %}selected{% endif %}>Todas as Marcas</option>
            {% for marca in marcas_disponiveis %}
              <option value="{{ marca }}" {% if marca_selecionada == marca %}selected{% endif %}>{{ marca }}</option>
            {% endfor %}
          </select>
        </div>
        
        <div class="filter-group">
          <label for="periodo">Per√≠odo:</label>
          <select name="periodo" id="periodo">
            <option value="todos" {% if periodo_selecionado == 'todos' %}selected{% endif %}>Todos os Per√≠odos</option>
            {% for periodo in periodos_disponiveis %}
              <option value="{{ periodo }}" {% if periodo_selecionado == periodo %}selected{% endif %}>{{ periodo }}</option>
            {% endfor %}
          </select>
        </div>
        
        <div class="filter-group">
          <label for="classe">Tipo de Unidade:</label>
          <select name="classe" id="classe">
            <option value="todas" {% if classe_selecionada == 'todas' %}selected{% endif %}>Motoristas e Ve√≠culos</option>
            <option value="motorista" {% if classe_selecionada == 'motorista' %}selected{% endif %}>Apenas Motoristas</option>
            <option value="veiculo" {% if classe_selecionada == 'veiculo' %}selected{% endif %}>Apenas Ve√≠culos</option>
          </select>
        </div>
        
        <div class="filter-group">
          <label for="filtro_combustivel">Consumo:</label>
          <select name="filtro_combustivel" id="filtro_combustivel">
            <option value="todos" {% if filtro_combustivel == 'todos' %}selected{% endif %}>Todos os Consumos</option>
            <option value="baixo" {% if filtro_combustivel == 'baixo' %}selected{% endif %}>Baixo Consumo (&lt; 200L)</option>
            <option value="medio" {% if filtro_combustivel == 'medio' %}selected{% endif %}>M√©dio Consumo (200-500L)</option>
            <option value="alto" {% if filtro_combustivel == 'alto' %}selected{% endif %}>Alto Consumo (&gt; 500L)</option>
          </select>
        </div>
        
        <div class="filter-group checkbox-group">
          <label>
            <input type="checkbox" name="remover_zero" {% if remover_zero %}checked{% endif %}>
            Remover zeros das estat√≠sticas
          </label>
        </div>
        
        <div class="filter-actions">
          <button type="submit" class="btn btn-primary">Aplicar Filtros</button>
          <a href="{% url 'report_empresa' %}" class="btn btn-secondary">Limpar</a>
        </div>
      </form>
    </div>

    <div class="header">
      <h1>{{ empresa_logada.nome }}</h1>
      <p class="tagline">Dashboard Executivo - Dados Exclusivos da Empresa</p>
      <div class="menu-buttons">
        <a href="{% url 'index' %}" class="btn btn-secondary">In√≠cio</a>
        <a href="{% url 'report_novo' %}" class="btn btn-secondary">Dashboard Global</a>
        <a href="{% url 'logout' %}" class="btn btn-primary">Logout</a>
      </div>
    </div>

    <main class="dashboard-container">
      <!-- KPIs Principais da Empresa -->
      <section class="kpis-overview">
        <div class="kpi-card">
          <h3>Total de Unidades</h3>
          <div class="kpi-value">{{ total_unidades }}</div>
          <p>Motoristas e Ve√≠culos</p>
        </div>
        
        <div class="kpi-card">
          <h3>Quilometragem Total</h3>
          <div class="kpi-value">{{ total_quilometragem|floatformat:0 }}</div>
          <p>km percorridos</p>
        </div>
        
        <div class="kpi-card">
          <h3>Consumo Total</h3>
          <div class="kpi-value">{{ total_consumo|floatformat:0 }}</div>
          <p>litros de combust√≠vel</p>
        </div>
        
        <div class="kpi-card">
          <h3>Efici√™ncia M√©dia</h3>
          <div class="kpi-value">{{ media_quilometragem|floatformat:1 }}</div>
          <p>km/l</p>
        </div>
        
        <div class="kpi-card">
          <h3>Economia Potencial</h3>
          <div class="kpi-value">R$ {{ economia_potencial|floatformat:0 }}</div>
          <p>com otimiza√ß√£o</p>
        </div>
      </section>

      <!-- Rankings de Performance -->
      <section class="rankings-section">
        <div class="ranking-container">
          <h3>üèÜ Top 10 Motoristas - Efici√™ncia</h3>
          <div class="ranking-list">
            {% for viagem in viagens_motoristas %}
              <div class="ranking-item">
                <span class="ranking-position">{{ forloop.counter }}¬∫</span>
                <span class="ranking-name">{{ viagem.unidade.nm }}</span>
                <span class="ranking-value">{{ viagem.Quilometragem_m√©dia|floatformat:1 }} km/l</span>
              </div>
            {% empty %}
              <p>Nenhum dado de motorista encontrado.</p>
            {% endfor %}
          </div>
        </div>
        
        <div class="ranking-container">
          <h3>üöõ Top 10 Ve√≠culos - Efici√™ncia</h3>
          <div class="ranking-list">
            {% for viagem in viagens_veiculos %}
              <div class="ranking-item">
                <span class="ranking-position">{{ forloop.counter }}¬∫</span>
                <span class="ranking-name">{{ viagem.unidade.nm }}</span>
                <span class="ranking-value">{{ viagem.Quilometragem_m√©dia|floatformat:1 }} km/l</span>
              </div>
            {% empty %}
              <p>Nenhum dado de ve√≠culo encontrado.</p>
            {% endfor %}
          </div>
        </div>
      </section>

      <!-- Estat√≠sticas por Marca -->
      {% if marcas_stats %}
      <section class="brands-section">
        <h3>üìä Estat√≠sticas por Marca</h3>
        <div class="brands-grid">
          {% for marca, stats in marcas_stats.items %}
            <div class="brand-card">
              <h4>{{ marca }}</h4>
              <div class="brand-stats">
                <div class="stat-item">
                  <strong>{{ stats.total_viagens }}</strong>
                  <span>viagens</span>
                </div>
                <div class="stat-item">
                  <strong>{{ stats.eficiencia_media|floatformat:1 }}</strong>
                  <span>km/l m√©dio</span>
                </div>
                <div class="stat-item">
                  <strong>{{ stats.total_quilometragem|floatformat:0 }}</strong>
                  <span>km total</span>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      </section>
      {% endif %}

      <!-- Lista de Todas as Unidades da Empresa -->
      <section class="units-section">
        <h3>üè¢ Todas as Unidades - {{ empresa_logada.nome }}</h3>
        <div class="units-table-container">
          <table class="units-table">
            <thead>
              <tr>
                <th>Nome</th>
                <th>Tipo</th>
                <th>Marca</th>
                <th>Total Viagens</th>
                <th>Efici√™ncia M√©dia</th>
                <th>√öltimo Per√≠odo</th>
              </tr>
            </thead>
            <tbody>
              {% for unidade in todas_unidades %}
                <tr>
                  <td>
                    <a href="{% url 'detalhes_unidade' unidade.id %}" class="unit-link">
                      {{ unidade.nm|default:"Sem nome" }}
                    </a>
                  </td>
                  <td>{{ unidade.cls }}</td>
                  <td>{{ unidade.marca|default:"N/A" }}</td>
                  <td>{{ unidade.total_viagens }}</td>
                  <td>
                    {% if unidade.eficiencia_media %}
                      {{ unidade.eficiencia_media|floatformat:1 }} km/l
                    {% else %}
                      N/A
                    {% endif %}
                  </td>
                  <td>{{ unidade.periodo_stats|default:"N/A" }}</td>
                </tr>
              {% empty %}
                <tr>
                  <td colspan="6">Nenhuma unidade encontrada para esta empresa.</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </section>

      <!-- An√°lise de Custos -->
      <section class="costs-section">
        <h3>üí∞ An√°lise de Custos</h3>
        <div class="costs-grid">
          <div class="cost-card">
            <h4>Custo Atual</h4>
            <div class="cost-value">R$ {{ custo_atual|floatformat:0 }}</div>
            <p>Com efici√™ncia de {{ media_km_atual|floatformat:1 }} km/l</p>
          </div>
          
          <div class="cost-card">
            <h4>Custo Objetivo</h4>
            <div class="cost-value">R$ {{ custo_objetivo|floatformat:0 }}</div>
            <p>Com efici√™ncia de {{ media_km_objetivo|floatformat:1 }} km/l</p>
          </div>
          
          <div class="cost-card highlight">
            <h4>Economia Potencial</h4>
            <div class="cost-value">R$ {{ economia_potencial|floatformat:0 }}</div>
            <p>Otimizando a efici√™ncia da frota</p>
          </div>
        </div>
      </section>

      <!-- Informa√ß√µes de Filtros Aplicados -->
      <section class="filters-info">
        <h4>Filtros Aplicados:</h4>
        <div class="filters-summary">
          <span class="filter-tag">Empresa: {{ empresa_logada.nome }}</span>
          <span class="filter-tag">Marca: {{ marca_selecionada|default:"Todas" }}</span>
          <span class="filter-tag">Per√≠odo: {{ periodo_selecionado|default:"Todos" }}</span>
          <span class="filter-tag">Classe: {{ classe_selecionada|default:"Todas" }}</span>
          <span class="filter-tag">Combust√≠vel: {{ filtro_combustivel|default:"Todos" }}</span>
        </div>
      </section>
    </main>

    <footer class="footer">
      <p>&copy; 2025 Umbrella360. Dashboard exclusivo para {{ empresa_logada.nome }}.</p>
      <p><em>"Dados inteligentes para decis√µes estrat√©gicas."</em></p>
    </footer>

    <!-- Scripts -->
    <script>
      // Script para toggle do painel de filtros
      document.getElementById('filters-toggle').addEventListener('click', function() {
        document.getElementById('filters-panel').classList.add('active');
      });
      
      document.getElementById('close-filters').addEventListener('click', function() {
        document.getElementById('filters-panel').classList.remove('active');
      });
      
      // Fechar painel ao clicar fora
      document.addEventListener('click', function(event) {
        const panel = document.getElementById('filters-panel');
        const toggle = document.getElementById('filters-toggle');
        
        if (!panel.contains(event.target) && !toggle.contains(event.target)) {
          panel.classList.remove('active');
        }
      });
    </script>
  </body>
</html>
