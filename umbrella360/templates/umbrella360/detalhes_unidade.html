{% load static %}
{% load umbrella_tags %}
<link rel="stylesheet" href="{% static 'umbrella360/style.css' %}?v=9">
<link rel="stylesheet" href="{% static 'umbrella360/style_refatorado.css' %}?v=2">
<link rel="stylesheet" href="{% static 'umbrella360/report_novo.css' %}?v=1">
<script src="{% static 'umbrella360/theme-toggle.js' %}?v=2"></script>
<script src="{% static 'umbrella360/table-sort.js' %}?v=1"></script>

<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalhes da Unidade {{ unidade.id }} - Umbrella360</title>
  </head>
  <body>
    <!-- Bot√£o de altern√¢ncia de tema -->
    <button id="theme-toggle" class="theme-toggle" title="Alternar tema">
      <span class="theme-icon">‚óê</span> Noite de Ver√£o
    </button>
    
    <div class="header">
      <h1>Detalhes da Unidade: {{ unidade.id }}</h1>
      <div class="menu-buttons">
        <a href="{% url 'lista_unidades' %}" class="btn btn-secondary">‚Üê Voltar √† Lista</a>
        <a href="{% url 'index' %}" class="btn btn-secondary">P√°gina Inicial</a>
      </div>
    </div>

    <main>
      <!-- Informa√ß√µes B√°sicas da Unidade -->
      <div style="display: flex; justify-content: center; margin-bottom: 2rem;">
        <div style="background: rgba(255, 255, 255, 0.95); border-radius: 15px; padding: 2rem; box-shadow: 0 10px 40px rgba(0,0,0,0.1); max-width: 1200px; width: 100%;">
          
          <!-- Cabe√ßalho da Unidade -->
          <div style="display: grid; grid-template-columns: auto 1fr auto; gap: 2rem; align-items: center; margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 2px solid #e9ecef;">
            <div style="font-size: 4rem;">
              {% if unidade.cls == 'Motorista' %}
                üìã        
              {% elif unidade.cls == 'Ve√≠culo' %}
                üìã              
              {% else %}
                üìã
              {% endif %}
            </div>
            <div>
              <h2 style="margin: 0; color: #2c3e50;">{{ unidade.nm|default:unidade.id }}</h2>
              <p style="margin: 0.5rem 0 0 0; color: #6c757d; font-size: 1.1rem;">
                <strong>{{ unidade.cls|title }}</strong> - {{ unidade.empresa.nome }}
              </p>
              {% if unidade.marca %}
                <p style="margin: 0.25rem 0 0 0; color: #495057;">
                  <strong>Marca:</strong> {{ unidade.marca }}
                </p>
              {% endif %}
              {% if unidade.placa %}
                <p style="margin: 0.25rem 0 0 0; color: #495057;">
                  <strong>Placa:</strong> {{ unidade.placa }}
                </p>
              {% endif %}
            </div>
            <div style="text-align: center;">
              {% if stats_gerais.total_viagens > 0 %}
                <div class="status-badge status-active">
                  ATIVO
                </div>
              {% else %}
                <div class="status-badge status-inactive">
                  INATIVO
                </div>
              {% endif %}
            </div>
          </div>

          <!-- KPIs Principais -->
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
            <div class="kpi-card kpi-consumo">
              <h4>Quilometragem Total</h4>
              <p>{{ stats_filtrados.total_quilometragem|floatformat:0|default:0 }} km</p>
            </div>
            <div class="kpi-card kpi-eficiencia">
              <h4>Efici√™ncia M√©dia</h4>
              <p>{{ stats_gerais.media_eficiencia|floatformat:2|default:0 }} km/L</p>
            </div>
            <div class="kpi-card kpi-custos">
              <h4>Custo Total</h4>
              <p>R$ {{ custo_total|floatformat:2|default:0 }}</p>
            </div>
          </div>

          <!-- M√©tricas Detalhadas -->
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
            <div class="metric-card">
              <h5>Consumo Total</h5>
              <p>{{ stats_gerais.total_consumo|floatformat:0|default:0 }} L</p>
            </div>
            {% if unidade.cls == 'Ve√≠culo' %}
            <div class="metric-card">
              <h5>Velocidade M√©dia</h5>
              <p>{{ stats_gerais.media_velocidade|floatformat:1|default:0 }} km/h</p>
            </div>
            <div class="metric-card">
              <h5>RPM M√©dio</h5>
              <p>{{ stats_gerais.media_rpm|floatformat:0|default:0 }}</p>
            </div>
            <div class="metric-card">
              <h5>Temperatura M√©dia</h5>
              <p>{{ stats_gerais.media_temperatura|floatformat:1|default:0 }}¬∞C</p>
            </div>
            {% endif %}
            <div class="metric-card">
              <h5>Emiss√µes CO2</h5>
              <p>{{ stats_gerais.total_emissoes|floatformat:0|default:0 }} t</p>
            </div>
          </div>

          <!-- Compara√ß√£o com M√©dia do Sistema -->
          <div class="comparison-section">
            <h4>Compara√ß√£o com M√©dia do Sistema</h4>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
              <div class="comparison-item">
                <p>Esta Unidade</p>
                <p class="comparison-value">{{ stats_gerais.media_eficiencia|floatformat:2|default:0 }} km/L</p>
              </div>
              <div class="comparison-item">
                <p>M√©dia de {{ unidade.cls|title }}s</p>
                <p class="comparison-value">{{ media_sistema|floatformat:2 }} km/L</p>
              </div>
            </div>
            <div class="performance-indicator">
              {% if stats_gerais.media_eficiencia > media_sistema %}
                <span class="indicator-good">Acima da M√©dia (+{{ stats_gerais.media_eficiencia|sub:media_sistema|floatformat:2 }} km/L)</span>
              {% elif stats_gerais.media_eficiencia < media_sistema %}
                <span class="indicator-poor">Abaixo da M√©dia (-{{ media_sistema|sub:stats_gerais.media_eficiencia|floatformat:2 }} km/L)</span>
              {% else %}
                <span class="indicator-average">Na M√©dia do Sistema</span>
              {% endif %}
            </div>
          </div>
        </div>
      </div>

      <!-- Estat√≠sticas por Per√≠odo -->
      {% if stats_por_periodo %}
      <h3 class="h3">Desempenho por Per√≠odo</h3>
      <table class="sortable-table">
        <thead>
          <tr>
            <th>Per√≠odo</th>
            <th>Quilometragem (km)</th>
            <th>Consumo (L)</th>
            <th>Efici√™ncia M√©dia (km/L)</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          {% for periodo in stats_por_periodo %}
          <tr>
            <td><strong>{{ periodo.per√≠odo|title }}</strong></td>
            <td>{{ periodo.quilometragem_periodo|floatformat:0|default:0 }}</td>
            <td>{{ periodo.consumo_periodo|floatformat:0|default:0 }}</td>
            <td>
              <span class="efficiency-indicator" data-efficiency="{{ periodo.eficiencia_periodo }}">
                {{ periodo.eficiencia_periodo|floatformat:2|default:0 }}
              </span>
            </td>
            <td>
              {% if periodo.eficiencia_periodo > media_sistema %}
                <span class="status-excellent">Excelente</span>
              {% elif periodo.eficiencia_periodo > 2.0 %}
                <span class="status-good">Bom</span>
              {% else %}
                <span class="status-poor">Ruim</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% endif %}

      <!-- Hist√≥rico de Viagens Recentes -->
      {% if viagens %}
      <h3 class="h3">Viagens Recentes</h3>
      <table class="sortable-table">
        <thead>
          <tr>
            <th>Per√≠odo</th>
            <th>Quilometragem (km)</th>
            <th>Consumo (L)</th>
            <th>Efici√™ncia (km/L)</th>
            {% if unidade.cls == 'Ve√≠culo' %}
            <th>Velocidade M√©dia</th>
            <th>RPM M√©dio</th>
            <th>Temperatura</th>
            {% endif %}
            <th>Emiss√µes CO2</th>
          </tr>
        </thead>
        <tbody>
          {% for viagem in viagens %}
          <tr>
            <td>{{ viagem.per√≠odo|title }}</td>
            <td>{{ viagem.quilometragem|floatformat:2 }}</td>
            <td>{{ viagem.Consumido }}</td>
            <td>
              <span class="efficiency-indicator" data-efficiency="{{ viagem.Quilometragem_m√©dia }}">
                {{ viagem.Quilometragem_m√©dia|floatformat:2 }}
              </span>
            </td>
            {% if unidade.cls == 'Ve√≠culo' %}
            <td>{{ viagem.Velocidade_m√©dia|floatformat:1|default:"-" }} km/h</td>
            <td>{{ viagem.RPM_m√©dio|floatformat:0|default:"-" }}</td>
            <td>{{ viagem.Temperatura_m√©dia|floatformat:1|default:"-" }}¬∞C</td>
            {% endif %}
            <td>{{ viagem.Emiss√µes_CO2|floatformat:1|default:"-" }} t</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      
      {% if total_viagens > 20 %}
      <div style="text-align: center; margin-top: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
        <p style="margin: 0; color: #6c757d;">
          <em>Mostrando apenas as 20 viagens mais recentes. Total de viagens: {{ total_viagens }}</em>
        </p>
      </div>
      {% endif %}
      {% else %}
      <div style="text-align: center; padding: 3rem; background: #f8f9fa; border-radius: 12px; margin: 2rem 0;">
        <h4 style="color: #6c757d; margin-bottom: 1rem;">üìã Nenhuma Viagem Registrada</h4>
        <p style="color: #6c757d; margin: 0;">Esta unidade ainda n√£o possui dados de viagens registrados no sistema.</p>
      </div>
      {% endif %}

    </main>

    <!-- Se√ß√£o de CheckPoints -->
    <section class="checkpoints-section" style="background: rgba(255, 255, 255, 0.95); margin: 2rem auto; max-width: 1200px; border-radius: 15px; padding: 2rem; box-shadow: 0 10px 40px rgba(0,0,0,0.1);">
      <h2 style="text-align: center; color: #2c3e50; margin-bottom: 2rem;">
      CheckPoints da Unidade
      </h2>
      
      <!-- Estat√≠sticas dos CheckPoints -->
      <div class="stats-overview" style="background: linear-gradient(135deg, #e3f2fd, #bbdefb); border-radius: 10px; padding: 1.5rem; margin-bottom: 2rem;">
        <div class="stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem;">
          <div class="stat-card" style="background: white; padding: 1.5rem; border-radius: 8px; text-align: center; border: 1px solid #e9ecef; transition: transform 0.3s ease;">
            <div class="stat-value" style="font-size: 1.8rem; font-weight: 700; color: #2c3e50; margin: 0.5rem 0;">{{ total_checkpoints_unidade|default:0 }}</div>
            <div class="stat-label" style="color: #6c757d; font-size: 0.9rem; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px;">Total de Passagens</div>
          </div>
          <div class="stat-card" style="background: white; padding: 1.5rem; border-radius: 8px; text-align: center; border: 1px solid #e9ecef; transition: transform 0.3s ease;">
            <div class="stat-value" style="font-size: 1.8rem; font-weight: 700; color: #2c3e50; margin: 0.5rem 0;">{{ cercas_utilizadas_unidade|default:0 }}</div>
            <div class="stat-label" style="color: #6c757d; font-size: 0.9rem; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px;">Cercas Utilizadas</div>
          </div>
          <div class="stat-card" style="background: white; padding: 1.5rem; border-radius: 8px; text-align: center; border: 1px solid #e9ecef; transition: transform 0.3s ease;">
            <div class="stat-value" style="font-size: 1.8rem; font-weight: 700; color: #2c3e50; margin: 0.5rem 0;">{{ duracao_media_checkpoints|default:0 }}</div>
            <div class="stat-label" style="color: #6c757d; font-size: 0.9rem; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px;">Dura√ß√£o M√©dia (min)</div>
          </div>
        </div>
      </div>

      <!-- Grid de CheckPoints -->
      <div class="ranking-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 3rem;">
        <!-- Cercas Mais Utilizadas por esta Unidade -->
        <div class="ranking-card" style="background: rgba(255, 255, 255, 0.95); border-radius: 15px; padding: 2rem; box-shadow: 0 10px 40px rgba(0,0,0,0.1); border: 1px solid #dee2e6;">
          <div class="ranking-header" style="text-align: center; margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 2px solid #e9ecef;">
            <h3 style="color: #2c3e50; font-size: 1.5rem; margin: 0; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">Cercas Mais Utilizadas</h3>
            <p style="color: #6c757d; margin: 0; font-size: 0.9rem;">Por n√∫mero de passagens desta unidade</p>
          </div>
          
          {% if cercas_unidade %}
            <ul class="ranking-list" style="list-style: none; padding: 0; margin: 0;">
              {% for cerca in cercas_unidade %}
              <li class="ranking-item" style="display: flex; align-items: center; padding: 1rem; margin-bottom: 0.75rem; border-radius: 8px; transition: all 0.3s ease; border: 1px solid #e9ecef;">
                <div class="ranking-position" style="font-size: 1.2rem; font-weight: 700; min-width: 40px; text-align: center; margin-right: 1rem; color: #6c757d;">
                  {{ forloop.counter }}¬∫
                </div>
                <div class="ranking-name" style="flex: 1; font-weight: 600; color: #495057; font-size: 1rem;">
                  {{ cerca.cerca|truncatechars:30 }}
                </div>
                <div class="ranking-value" style="font-weight: 700; color: #28a745; font-size: 1.1rem; padding: 0.25rem 0.75rem; background: linear-gradient(135deg, #d4edda, #c3e6cb); border-radius: 20px; border: 1px solid #28a745;">
                  {{ cerca.total_passagens }}
                </div>
              </li>
              {% endfor %}
            </ul>
          {% else %}
            <div style="text-align: center; padding: 3rem; color: #6c757d;">
              <p><strong>Nenhuma cerca encontrada</strong></p>
              <p>Esta unidade n√£o possui registros de checkpoints.</p>
            </div>
          {% endif %}
        </div>

        <!-- √öltimas Passagens -->
        <div class="ranking-card" style="background: rgba(255, 255, 255, 0.95); border-radius: 15px; padding: 2rem; box-shadow: 0 10px 40px rgba(0,0,0,0.1); border: 1px solid #dee2e6;">
          <div class="ranking-header" style="text-align: center; margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 2px solid #e9ecef;">
            <h3 style="color: #2c3e50; font-size: 1.5rem; margin: 0; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">√öltimas Passagens</h3>
            <p style="color: #6c757d; margin: 0; font-size: 0.9rem;">Registros mais recentes</p>
          </div>
          
          {% if checkpoints_recentes_unidade %}
            <ul class="ranking-list" style="list-style: none; padding: 0; margin: 0;">
              {% for checkpoint in checkpoints_recentes_unidade %}
              <li class="ranking-item" style="display: flex; flex-direction: column; padding: 1rem; margin-bottom: 0.75rem; border-radius: 8px; transition: all 0.3s ease; border: 1px solid #e9ecef;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                  <strong style="color: #495057;">{{ checkpoint.cerca|truncatechars:25 }}</strong>
                  <span style="color: #6c757d; font-size: 0.9rem;">{{ checkpoint.per√≠odo }}</span>
                </div>
                <div style="display: flex; justify-content: space-between; font-size: 0.85rem; color: #6c757d;">
                  <span>Entrada: {{ checkpoint.data_entrada|date:"d/m H:i"|default:"-" }}</span>
                  {% if checkpoint.duracao %}
                    <span>{{ checkpoint.duracao|default:"-" }}</span>
                  {% endif %}
                </div>
              </li>
              {% endfor %}
            </ul>
          {% else %}
            <div style="text-align: center; padding: 3rem; color: #6c757d;">
              <p><strong>Nenhum checkpoint encontrado</strong></p>
              <p>Esta unidade n√£o possui registros recentes de checkpoints.</p>
            </div>
          {% endif %}
        </div>
      </div>

      <!-- Hist√≥rico Detalhado de CheckPoints -->
      {% if checkpoints_detalhados_unidade %}
      <div class="ranking-card" style="margin-top: 2rem; background: rgba(255, 255, 255, 0.95); border-radius: 15px; padding: 2rem; box-shadow: 0 10px 40px rgba(0,0,0,0.1); border: 1px solid #dee2e6;">
        <div class="ranking-header" style="text-align: center; margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 2px solid #e9ecef;">
          <h3 style="color: #2c3e50; font-size: 1.5rem; margin: 0; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">üìã Hist√≥rico Detalhado de Passagens</h3>
          <p style="color: #6c757d; margin: 0; font-size: 0.9rem;">Todas as passagens registradas</p>
        </div>
        
        <div style="overflow-x: auto;">
          <table style="width: 100%; border-collapse: collapse; margin-top: 1rem;">
            <thead>
              <tr style="background: #f8f9fa;">
                <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid #dee2e6; color: #495057;">Cerca</th>
                <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid #dee2e6; color: #495057;">Per√≠odo</th>
                <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid #dee2e6; color: #495057;">Data Entrada</th>
                <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid #dee2e6; color: #495057;">Data Sa√≠da</th>
                <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid #dee2e6; color: #495057;">Dura√ß√£o</th>
              </tr>
            </thead>
            <tbody>
              {% for checkpoint in checkpoints_detalhados_unidade %}
              <tr style="border-bottom: 1px solid #e9ecef;">
                <td style="padding: 0.75rem; color: #495057;">{{ checkpoint.cerca|truncatechars:30 }}</td>
                <td style="padding: 0.75rem; color: #6c757d;">{{ checkpoint.per√≠odo }}</td>
                <td style="padding: 0.75rem; color: #6c757d;">{{ checkpoint.data_entrada|date:"d/m/Y H:i"|default:"-" }}</td>
                <td style="padding: 0.75rem; color: #6c757d;">{{ checkpoint.data_saida|date:"d/m/Y H:i"|default:"-" }}</td>
                <td style="padding: 0.75rem; color: #6c757d;">{{ checkpoint.duracao|default:"-" }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        
        {% if total_checkpoints_unidade > 20 %}
        <div style="text-align: center; margin-top: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
          <p style="margin: 0; color: #6c757d;">
            <em>Mostrando apenas os 20 checkpoints mais recentes. Total de checkpoints: {{ total_checkpoints_unidade }}</em>
          </p>
        </div>
        {% endif %}
      </div>
      {% endif %}

    </section>
    
    <footer class="footer">
      <p>&copy; 2025 Umbrella360. Transformando o Brasil atrav√©s da log√≠stica inteligente.</p>
      <p><em>"N√≥s enxergamos um mundo mais justo, mais humano e mais sustent√°vel."</em></p>
    </footer>

    <style>
    .status-badge {
        padding: 0.5rem 1rem;
        border-radius: 25px;
        font-weight: bold;
        font-size: 0.9rem;
    }
    
    .status-active {
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
    }
    
    .status-inactive {
        background: linear-gradient(135deg, #dc3545, #e83e8c);
        color: white;
    }
    
    .metric-card {
        background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        padding: 1rem;
        border-radius: 8px;
        text-align: center;
        border: 1px solid #dee2e6;
    }
    
    .metric-card h5 {
        margin: 0 0 0.5rem 0;
        color: #495057;
        font-size: 0.9rem;
    }
    
    .metric-card p {
        margin: 0;
        font-size: 1.5rem;
        font-weight: bold;
        color: #2c3e50;
    }
    
    .comparison-section {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        padding: 1.5rem;
        border-radius: 12px;
        text-align: center;
    }
    
    .comparison-item p:first-child {
        margin: 0;
        font-size: 0.9rem;
        opacity: 0.9;
    }
    
    .comparison-value {
        margin: 0.5rem 0 0 0 !important;
        font-size: 1.8rem !important;
        font-weight: bold !important;
    }
    
    .performance-indicator {
        margin-top: 1rem;
        padding: 0.75rem;
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.1);
    }
    
    .indicator-good {
        color: #d4edda;
        font-weight: bold;
    }
    
    .indicator-poor {
        color: #f8d7da;
        font-weight: bold;
    }
    
    .indicator-average {
        color: #fff3cd;
        font-weight: bold;
    }
    
    .kpi-eficiencia {
        --bg-start: #6f42c1;
        --bg-end: #e83e8c;
    }
    
    .kpi-custos {
        --bg-start: #fd7e14;
        --bg-end: #dc3545;
    }
    
    /* Estilos para se√ß√£o de checkpoints */
    .ranking-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
        margin-bottom: 3rem;
    }
    
    .ranking-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        border-color: #007bff !important;
    }
    
    .stat-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    /* Responsividade para checkpoints */
    @media (max-width: 768px) {
        .ranking-grid {
            grid-template-columns: 1fr;
        }
        
        .stats-grid {
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)) !important;
        }
        
        .ranking-item {
            flex-direction: column;
            text-align: center;
            gap: 0.5rem;
        }
        
        .ranking-position {
            margin-right: 0 !important;
        }
        
        table {
            font-size: 0.85rem;
        }
        
        th, td {
            padding: 0.5rem !important;
        }
        
        .checkpoints-section {
            margin: 1rem !important;
            padding: 1rem !important;
        }
    }
    </style>
  </body>
</html>
