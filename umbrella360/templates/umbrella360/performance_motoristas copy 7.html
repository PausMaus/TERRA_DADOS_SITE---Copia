{% load static %}
{% load umbrella_tags %}
<link rel="stylesheet" href="{% static 'umbrella360/style.css' %}?v=9">
<link rel="stylesheet" href="{% static 'umbrella360/style_refatorado.css' %}?v=2">
<link rel="stylesheet" href="{% static 'umbrella360/report_novo.css' %}?v=1">
<script src="{% static 'umbrella360/theme-toggle.js' %}?v=2"></script>
<script src="{% static 'umbrella360/table-sort.js' %}?v=1"></script>

<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Performance dos Motoristas - Umbrella360</title>
    
    <!-- Chart.js e plugins - CARREGADOS NO HEAD -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@sgratzl/chartjs-chart-boxplot@3.7.0/build/index.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-matrix@1.3.0/dist/chartjs-chart-matrix.min.js"></script>
  </head>
  <body>
    <!-- Bot√£o de altern√¢ncia de tema -->
    <button id="theme-toggle" class="theme-toggle" title="Alternar tema">
      <span class="theme-icon">‚óê</span> Noite de Ver√£o
    </button>
    
    <div class="header">
      <div class="menu-buttons">
            <a href="{% url 'index' %}" class="btn btn-primary">In√≠cio</a>
            <a href="{% url 'report_empresa' %}" class="btn btn-secondary">Painel</a>
            <a href="{% url 'ranking_empresa' %}" class="btn btn-secondary">Ranking</a>
      </div>
    </div>

    <main style="max-width: 1400px; margin: 0 auto; padding: 2rem;">

      <!-- Cabe√ßalho -->


      <!-- Estat√≠sticas Gerais da Frota -->
            <!-- üî• NOVO: Formul√°rio de Filtros -->
      <div style="background: white; border-radius: 15px; padding: 1.5rem; margin-bottom: 2rem; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
        <form method="get" id="filterForm" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; align-items: end;">
          
          <!-- Seletor de Per√≠odo R√°pido -->
          <div>
            <label for="periodo_dias" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #2c3e50;">
              üìÖ Per√≠odo R√°pido
            </label>
            <select name="periodo_dias" id="periodo_dias" onchange="toggleDateInputs(this.value)" 
                    style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem;">
              <option value="7" {% if periodo_dias == '7' %}selected{% endif %}>√öltimos 7 dias</option>
              <option value="15" {% if periodo_dias == '15' %}selected{% endif %}>√öltimos 15 dias</option>
              <option value="30" {% if periodo_dias == '30' or not periodo_dias %}selected{% endif %}>√öltimos 30 dias</option>
              <option value="60" {% if periodo_dias == '60' %}selected{% endif %}>√öltimos 60 dias</option>
              <option value="90" {% if periodo_dias == '90' %}selected{% endif %}>√öltimos 90 dias</option>
              <option value="todos" {% if periodo_dias == 'todos' %}selected{% endif %}>Todos os dados</option>
              <option value="personalizado" {% if data_inicio and data_fim %}selected{% endif %}>üìÜ Personalizado</option>
            </select>
          </div>
          
          <!-- Data In√≠cio (oculto por padr√£o) -->
          <div id="dataInicioDiv" style="{% if not data_inicio %}display: none;{% endif %}">
            <label for="data_inicio" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #2c3e50;">
              Data In√≠cio
            </label>
            <input type="date" name="data_inicio" id="data_inicio" value="{{ data_inicio }}"
                  style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem;">
          </div>
          
          <!-- Data Fim (oculto por padr√£o) -->
          <div id="dataFimDiv" style="{% if not data_fim %}display: none;{% endif %}">
            <label for="data_fim" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #2c3e50;">
              Data Fim
            </label>
            <input type="date" name="data_fim" id="data_fim" value="{{ data_fim }}"
                  style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem;">
          </div>
          
          <!-- Bot√£o Aplicar -->
          <div>
            <button type="submit" style="width: 100%; padding: 0.75rem 1.5rem; background: linear-gradient(135deg, #667eea, #764ba2); 
                    color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 1rem; 
                    transition: transform 0.2s;">
              üîç Aplicar Filtro
            </button>
          </div>
          
          <!-- Bot√£o Limpar -->
          <div>
            <a href="{% url 'performance_motoristas' %}" style="display: block; width: 100%; padding: 0.75rem 1.5rem; 
              background: #6c757d; color: white; border: none; border-radius: 8px; font-weight: 600; 
              text-align: center; text-decoration: none; transition: transform 0.2s;">
              üîÑ Limpar Filtros
            </a>
          </div>
          
        </form>
      </div>

      <div class="stats-overview" style="background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 15px; padding: 2rem; margin-bottom: 2rem; color: white;">
        <h2 style="text-align: center; margin-bottom: 2rem; font-size: 2rem;">üìä Performance dos Motoristas</h2>

        <div class="stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem;">
          <div class="stat-card" style="background: rgba(255, 255, 255, 0.15); padding: 1.5rem; border-radius: 8px; text-align: center; border: 1px solid rgba(255, 255, 255, 0.2); backdrop-filter: blur(10px);">
            <div class="stat-value" style="font-size: 2.5rem; font-weight: 700; color: white; margin: 0.5rem 0;">
              {{ stats_gerais.total_motoristas }}
            </div>
            <div class="stat-label" style="color: rgba(255, 255, 255, 0.9); font-size: 0.9rem; font-weight: 500; text-transform: uppercase;">Total de Motoristas</div>
          </div>
          
          <div class="stat-card" style="background: rgba(255, 255, 255, 0.15); padding: 1.5rem; border-radius: 8px; text-align: center; border: 1px solid rgba(255, 255, 255, 0.2); backdrop-filter: blur(10px);">
            <div class="stat-value" style="font-size: 2.5rem; font-weight: 700; color: white; margin: 0.5rem 0;">
              {{ stats_gerais.total_pontos|floatformat:0 }}
            </div>
            <div class="stat-label" style="color: rgba(255, 255, 255, 0.9); font-size: 0.9rem; font-weight: 500; text-transform: uppercase;">Total de Pontos Analisados</div>
          </div>
          
          <div class="stat-card" style="background: rgba(255, 255, 255, 0.15); padding: 1.5rem; border-radius: 8px; text-align: center; border: 1px solid rgba(255, 255, 255, 0.2); backdrop-filter: blur(10px);">
            <div class="stat-value" style="font-size: 2.5rem; font-weight: 700; color: white; margin: 0.5rem 0;">
              {{ stats_gerais.rpm_medio_geral|floatformat:0 }}
            </div>
            <div class="stat-label" style="color: rgba(255, 255, 255, 0.9); font-size: 0.9rem; font-weight: 500; text-transform: uppercase;">RPM M√©dio Geral</div>
          </div>
          
          <div class="stat-card" style="background: rgba(255, 255, 255, 0.15); padding: 1.5rem; border-radius: 8px; text-align: center; border: 1px solid rgba(255, 255, 255, 0.2); backdrop-filter: blur(10px);">
            <div class="stat-value" style="font-size: 2.5rem; font-weight: 700; color: white; margin: 0.5rem 0;">
              {{ stats_gerais.velocidade_media_geral|floatformat:0 }}
            </div>
            <div class="stat-label" style="color: rgba(255, 255, 255, 0.9); font-size: 0.9rem; font-weight: 500; text-transform: uppercase;">Velocidade M√©dia (km/h)</div>
          </div>
          
          <div class="stat-card" style="background: rgba(33, 150, 243, 0.3); padding: 1.5rem; border-radius: 8px; text-align: center; border: 1px solid rgba(255, 255, 255, 0.3); backdrop-filter: blur(10px);">
            <div class="stat-value" style="font-size: 2.5rem; font-weight: 700; color: #bbdefb; margin: 0.5rem 0;">
              {{ stats_gerais.perc_azul_geral|floatformat:1 }}%
            </div>
            <div class="stat-label" style="color: rgba(255, 255, 255, 0.9); font-size: 0.9rem; font-weight: 500; text-transform: uppercase;">üîµ Faixa Azul (Econ√¥mica)</div>
          </div>
          
          <div class="stat-card" style="background: rgba(40, 167, 69, 0.3); padding: 1.5rem; border-radius: 8px; text-align: center; border: 1px solid rgba(255, 255, 255, 0.3); backdrop-filter: blur(10px);">
            <div class="stat-value" style="font-size: 2.5rem; font-weight: 700; color: #d4edda; margin: 0.5rem 0;">
              {{ stats_gerais.perc_verde_geral|floatformat:1 }}%
            </div>
            <div class="stat-label" style="color: rgba(255, 255, 255, 0.9); font-size: 0.9rem; font-weight: 500; text-transform: uppercase;">üü¢ Faixa Verde (Ideal)</div>
          </div>
          
          <div class="stat-card" style="background: rgba(255, 152, 0, 0.3); padding: 1.5rem; border-radius: 8px; text-align: center; border: 1px solid rgba(255, 255, 255, 0.3); backdrop-filter: blur(10px);">
            <div class="stat-value" style="font-size: 2.5rem; font-weight: 700; color: #ffe0b2; margin: 0.5rem 0;">
              {{ stats_gerais.perc_amarela_geral|floatformat:1 }}%
            </div>
            <div class="stat-label" style="color: rgba(255, 255, 255, 0.9); font-size: 0.9rem; font-weight: 500; text-transform: uppercase;">üü° Faixa Amarela (Aten√ß√£o)</div>
          </div>
          
          <div class="stat-card" style="background: rgba(220, 53, 69, 0.3); padding: 1.5rem; border-radius: 8px; text-align: center; border: 1px solid rgba(255, 255, 255, 0.3); backdrop-filter: blur(10px);">
            <div class="stat-value" style="font-size: 2.5rem; font-weight: 700; color: #f8d7da; margin: 0.5rem 0;">
              {{ stats_gerais.perc_vermelha_geral|floatformat:1 }}%
            </div>
            <div class="stat-label" style="color: rgba(255, 255, 255, 0.9); font-size: 0.9rem; font-weight: 500; text-transform: uppercase;">üî¥ Faixa Vermelha (Cr√≠tico)</div>
          </div>
          
          <div class="stat-card" style="background: rgba(108, 117, 125, 0.3); padding: 1.5rem; border-radius: 8px; text-align: center; border: 1px solid rgba(255, 255, 255, 0.3); backdrop-filter: blur(10px);">
            <div class="stat-value" style="font-size: 2.5rem; font-weight: 700; color: #e0e0e0; margin: 0.5rem 0;">
              {{ stats_gerais.perc_ocioso_geral|floatformat:1 }}%
            </div>
            <div class="stat-label" style="color: rgba(255, 255, 255, 0.9); font-size: 0.9rem; font-weight: 500; text-transform: uppercase;">‚ö™ Ociosidade</div>
          </div>
        </div>
      </div>

      <!-- Legenda das Faixas de RPM -->
      <div style="background: white; border-radius: 10px; padding: 1.5rem; margin-bottom: 2rem; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
          <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem; background: #e3f2fd; border-radius: 8px; border-left: 4px solid #2196F3;">
            <span style="font-size: 1.5rem;">üîµ</span>
            <div>
              <strong>Azul (350-799 RPM)</strong>
              <p style="margin: 0; font-size: 0.85rem; color: #555;">Econ√¥mica</p>
            </div>
          </div>
          
          <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem; background: #e8f5e9; border-radius: 8px; border-left: 4px solid #4CAF50;">
            <span style="font-size: 1.5rem;">üü¢</span>
            <div>
              <strong>Verde (800-1300 RPM)</strong>
              <p style="margin: 0; font-size: 0.85rem; color: #555;">Ideal</p>
            </div>
          </div>
          
          <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem; background: #fff3e0; border-radius: 8px; border-left: 4px solid #FF9800;">
            <span style="font-size: 1.5rem;">üü°</span>
            <div>
              <strong>Amarela (1301-2300 RPM)</strong>
              <p style="margin: 0; font-size: 0.85rem; color: #555;">Aten√ß√£o</p>
            </div>
          </div>
          
          <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem; background: #ffebee; border-radius: 8px; border-left: 4px solid #f44336;">
            <span style="font-size: 1.5rem;">üî¥</span>
            <div>
              <strong>Vermelha (‚â•2301 RPM)</strong>
              <p style="margin: 0; font-size: 0.85rem; color: #555;">Cr√≠tica</p>
            </div>
          </div>
        </div>
      </div>
      

      <!-- Gr√°fico de Dispers√£o Unificado: Faixas de RPM vs Score -->
      {% if motoristas_performance %}
      <div style="background: white; border-radius: 15px; padding: 2rem; margin-bottom: 2rem; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
        <h3 style="text-align: center; margin-bottom: 1.5rem; color: #2c3e50; font-size: 1.5rem;">
        Correla√ß√£o: Faixas de RPM vs Score de Performance
        </h3>
        
        <!-- Bot√µes de Toggle -->
        <div style="display: flex; justify-content: center; flex-wrap: wrap; gap: 1rem; margin-bottom: 2rem;">
          <button id="toggleVerdeBtn" onclick="toggleDataset(0)" style="padding: 0.75rem 1.5rem; background: linear-gradient(135deg, #4CAF50, #66BB6A); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 8px rgba(76, 175, 80, 0.3);">
            üü¢ Faixa Verde
          </button>
          
          <button id="toggleVermelhaBtn" onclick="toggleDataset(1)" style="padding: 0.75rem 1.5rem; background: linear-gradient(135deg, #f44336, #e57373); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 8px rgba(244, 67, 54, 0.3);">
            üî¥ Faixa Vermelha
          </button>
          
          <button id="toggleAzulBtn" onclick="toggleDataset(2)" style="padding: 0.75rem 1.5rem; background: linear-gradient(135deg, #2196F3, #64B5F6); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 8px rgba(33, 150, 243, 0.3);">
            ÔøΩ Faixa Azul
          </button>
          
          <button id="toggleAmarelaBtn" onclick="toggleDataset(3)" style="padding: 0.75rem 1.5rem; background: linear-gradient(135deg, #FF9800, #FFB74D); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 8px rgba(255, 152, 0, 0.3);">
            üü° Faixa Amarela
          </button>
          
          <button id="toggleRPMBtn" onclick="toggleDataset(4)" style="padding: 0.75rem 1.5rem; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);">
            ‚öôÔ∏è RPM M√©dio
          </button>
          
          <button id="toggleOciosoBtn" onclick="toggleDataset(5)" style="padding: 0.75rem 1.5rem; background: linear-gradient(135deg, #6c757d, #9e9e9e); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 8px rgba(108, 117, 125, 0.3);">
            ‚ö™ Ociosidade
          </button>
          
          <button onclick="toggleAllDatasets()" style="padding: 0.75rem 1.5rem; background: linear-gradient(135deg, #34495e, #5d6d7e); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 8px rgba(52, 73, 94, 0.3);">
            üîÑ Todos
          </button>
        </div>
        
        <!-- Gr√°fico Unificado -->
        <div style="position: relative; height: 500px;">
          <canvas id="chartUnificado"></canvas>
        </div>
        
        <!-- Estat√≠sticas de Correla√ß√£o -->
        <div style="margin-top: 2rem; padding: 1.5rem; background: #f8f9fa; border-radius: 10px; border-left: 4px solid #667eea;">
          <h4 style="color: #2c3e50; margin-bottom: 1rem;">üìà An√°lise de Correla√ß√£o</h4>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; font-size: 0.9rem;">
            <div>
              <strong style="color: #4CAF50;">üü¢ Faixa Verde:</strong>
              <p id="correlVerdeScore" style="margin: 0.25rem 0; color: #667eea; font-weight: 600;"></p>
            </div>
            <div>
              <strong style="color: #f44336;">üî¥ Faixa Vermelha:</strong>
              <p id="correlVermelhaScore" style="margin: 0.25rem 0; color: #667eea; font-weight: 600;"></p>
            </div>
            <div>
              <strong style="color: #2196F3;">ÔøΩ Faixa Azul:</strong>
              <p id="correlAzulScore" style="margin: 0.25rem 0; color: #667eea; font-weight: 600;"></p>
            </div>
            <div>
              <strong style="color: #FF9800;">üü° Faixa Amarela:</strong>
              <p id="correlAmarelaScore" style="margin: 0.25rem 0; color: #667eea; font-weight: 600;"></p>
            </div>
            <div>
              <strong style="color: #667eea;">‚öôÔ∏è RPM M√©dio:</strong>
              <p id="correlRPMScore" style="margin: 0.25rem 0; color: #667eea; font-weight: 600;"></p>
            </div>
            <div>
              <strong style="color: #6c757d;">‚ö™ Ociosidade:</strong>
              <p id="correlOciosoScore" style="margin: 0.25rem 0; color: #667eea; font-weight: 600;"></p>
            </div>
          </div>
        </div>
      </div>
      {% endif %}

      <!-- Novos Gr√°ficos Anal√≠ticos -->
      {% if motoristas_performance %}
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 2rem; margin-bottom: 2rem;">
        
        <!-- Gr√°fico 1: Pizza - Distribui√ß√£o das Faixas de RPM -->
        <div style="background: white; border-radius: 15px; padding: 2rem; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
          <h3 style="text-align: center; margin-bottom: 1.5rem; color: #2c3e50; font-size: 1.3rem;">
            ü•ß Distribui√ß√£o Geral das Faixas de RPM
          </h3>
          <div style="position: relative; height: 350px;">
            <canvas id="chartPizzaFaixas"></canvas>
          </div>
          <p style="text-align: center; color: #666; font-size: 0.9rem; margin-top: 1rem;">
            Propor√ß√£o de tempo que a frota passa em cada faixa de opera√ß√£o
          </p>
        </div>

        <!-- Gr√°fico 2: Barras Horizontais - Top 10 por Score -->
        <div style="background: white; border-radius: 15px; padding: 2rem; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
          <h3 style="text-align: center; margin-bottom: 1.5rem; color: #2c3e50; font-size: 1.3rem;">
            üèÜ Top 10 Motoristas por Score
          </h3>
          <div style="position: relative; height: 350px;">
            <canvas id="chartTop10Score"></canvas>
          </div>
          <p style="text-align: center; color: #666; font-size: 0.9rem; margin-top: 1rem;">
            Ranking dos motoristas com melhor desempenho geral
          </p>
        </div>

      </div>

      <!-- Gr√°ficos Complementares (largura completa) -->
      <div style="display: grid; gap: 2rem; margin-bottom: 2rem;">
        
        <!-- Gr√°fico 3: Barras Empilhadas - Composi√ß√£o de Faixas -->
        <div style="background: white; border-radius: 15px; padding: 2rem; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
          <h3 style="text-align: center; margin-bottom: 1.5rem; color: #2c3e50; font-size: 1.3rem;">
            üìä Composi√ß√£o de Faixas de RPM por Motorista (Top 10)
          </h3>
          <div style="position: relative; height: 400px;">
            <canvas id="chartComposicaoFaixas"></canvas>
          </div>
          <p style="text-align: center; color: #666; font-size: 0.9rem; margin-top: 1rem;">
            Distribui√ß√£o percentual das faixas de RPM para os melhores motoristas
          </p>
        </div>

        <!-- Gr√°fico 4: Barras Agrupadas - RPM vs Velocidade -->
        <div style="background: white; border-radius: 15px; padding: 2rem; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
          <h3 style="text-align: center; margin-bottom: 1.5rem; color: #2c3e50; font-size: 1.3rem;">
            ‚ö° RPM M√©dio vs Velocidade M√©dia (Top 10)
          </h3>
          <div style="position: relative; height: 400px;">
            <canvas id="chartRPMVelocidade"></canvas>
          </div>
          <p style="text-align: center; color: #666; font-size: 0.9rem; margin-top: 1rem;">
            Compara√ß√£o entre RPM m√©dio e velocidade m√©dia dos melhores motoristas
          </p>
        </div>

      </div>

      <!-- Box Plot - Distribui√ß√£o Estat√≠stica -->
      <div style="background: white; border-radius: 15px; padding: 2rem; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 2rem;">
        <h3 style="text-align: center; margin-bottom: 1.5rem; color: #2c3e50; font-size: 1.3rem;">
          üì¶ Box Plot: Distribui√ß√£o Estat√≠stica das M√©tricas
        </h3>
        <div style="position: relative; height: 450px;">
          <canvas id="chartBoxPlot"></canvas>
        </div>
        <div style="margin-top: 1.5rem; padding: 1rem; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #667eea;">
          <h4 style="color: #2c3e50; margin-bottom: 0.75rem; font-size: 1.1rem;">üìä Como Interpretar:</h4>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1rem; font-size: 0.9rem; color: #555;">
            <div>
              <strong style="color: #667eea;">üì¶ Caixa (Box):</strong> 
              <p style="margin: 0.25rem 0;">Cont√©m 50% dos dados centrais (Q1 a Q3)</p>
            </div>
            <div>
              <strong style="color: #4CAF50;">‚îÅ Linha Central:</strong> 
              <p style="margin: 0.25rem 0;">Mediana (valor do meio)</p>
            </div>
            <div>
              <strong style="color: #FF9800;">‚îÉ Bigodes:</strong> 
              <p style="margin: 0.25rem 0;">Alcance dos dados (exceto outliers)</p>
            </div>
            <div>
              <strong style="color: #f44336;">‚óè Outliers:</strong> 
              <p style="margin: 0.25rem 0;">Valores extremos (anormais)</p>
            </div>
          </div>
        </div>
        <p style="text-align: center; color: #666; font-size: 0.9rem; margin-top: 1rem;">
          Identifica a dispers√£o, valores t√≠picos e motoristas com comportamento at√≠pico (outliers)
        </p>
      </div>

      <!-- Heatmap - Matriz de Correla√ß√£o -->
      <div style="background: white; border-radius: 15px; padding: 2rem; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 2rem;">
        <h3 style="text-align: center; margin-bottom: 1.5rem; color: #2c3e50; font-size: 1.3rem;">
          üó∫Ô∏è Heatmap: Matriz de Correla√ß√£o entre M√©tricas
        </h3>
        <div style="position: relative; height: 500px;">
          <canvas id="chartHeatmap"></canvas>
        </div>
        <div style="margin-top: 1.5rem; padding: 1rem; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #667eea;">
          <h4 style="color: #2c3e50; margin-bottom: 0.75rem; font-size: 1.1rem;">üé® Escala de Cores:</h4>
          <div style="display: flex; align-items: center; justify-content: center; gap: 1rem; margin-bottom: 1rem;">
            <div style="display: flex; align-items: center; gap: 0.5rem;">
              <div style="width: 40px; height: 20px; background: linear-gradient(90deg, #d32f2f, #f44336); border-radius: 4px;"></div>
              <span style="font-size: 0.9rem; color: #555;">-1.0 a -0.5</span>
            </div>
            <div style="display: flex; align-items: center; gap: 0.5rem;">
              <div style="width: 40px; height: 20px; background: linear-gradient(90deg, #ff9800, #ffeb3b); border-radius: 4px;"></div>
              <span style="font-size: 0.9rem; color: #555;">-0.5 a 0</span>
            </div>
            <div style="display: flex; align-items: center; gap: 0.5rem;">
              <div style="width: 40px; height: 20px; background: #ffffff; border: 1px solid #ddd; border-radius: 4px;"></div>
              <span style="font-size: 0.9rem; color: #555;">0</span>
            </div>
            <div style="display: flex; align-items: center; gap: 0.5rem;">
              <div style="width: 40px; height: 20px; background: linear-gradient(90deg, #81c784, #4caf50); border-radius: 4px;"></div>
              <span style="font-size: 0.9rem; color: #555;">0 a +0.5</span>
            </div>
            <div style="display: flex; align-items: center; gap: 0.5rem;">
              <div style="width: 40px; height: 20px; background: linear-gradient(90deg, #2e7d32, #1b5e20); border-radius: 4px;"></div>
              <span style="font-size: 0.9rem; color: #555;">+0.5 a +1.0</span>
            </div>
          </div>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; font-size: 0.9rem; color: #555;">
            <div>
              <strong style="color: #4CAF50;">üü¢ Verde Escuro:</strong> 
              <p style="margin: 0.25rem 0;">Correla√ß√£o positiva forte (quanto mais uma m√©trica, mais a outra)</p>
            </div>
            <div>
              <strong style="color: #d32f2f;">üî¥ Vermelho:</strong> 
              <p style="margin: 0.25rem 0;">Correla√ß√£o negativa forte (quanto mais uma m√©trica, menos a outra)</p>
            </div>
            <div>
              <strong style="color: #666;">‚ö™ Branco/Claro:</strong> 
              <p style="margin: 0.25rem 0;">Sem correla√ß√£o (m√©tricas independentes)</p>
            </div>
          </div>
        </div>
        <p style="text-align: center; color: #666; font-size: 0.9rem; margin-top: 1rem;">
          Identifica rela√ß√µes ocultas entre m√©tricas e ajuda a entender o que realmente impacta o Score
        </p>
      </div>
      {% endif %}

      <!-- Tabela de Performance por Motorista -->
      {% if motoristas_performance %}
      <div style="background: white; border-radius: 15px; padding: 2rem; box-shadow: 0 10px 40px rgba(0,0,0,0.1); margin-bottom: 2rem;">
        <div style="overflow-x: auto;">
          <table class="sortable-table" style="width: 100%; border-collapse: collapse; font-size: 0.95rem;">
            <thead>
              <tr style="background: linear-gradient(135deg, #667eea, #764ba2); color: white;">
                <th style="padding: 1rem; text-align: center; border: 1px solid #dee2e6;">Ranking</th>
                <th style="padding: 1rem; text-align: left; border: 1px solid #dee2e6;">Motorista</th>
                <th style="padding: 1rem; text-align: center; border: 1px solid #dee2e6;">Ve√≠culos</th>
                <th style="padding: 1rem; text-align: center; border: 1px solid #dee2e6;">Pontos</th>
                <th style="padding: 1rem; text-align: center; border: 1px solid #dee2e6;">RPM M√©dio</th>
                <th style="padding: 1rem; text-align: center; border: 1px solid #dee2e6;">Vel. M√©dia</th>
                <th style="padding: 1rem; text-align: center; border: 1px solid #dee2e6;">üîµ Azul</th>
                <th style="padding: 1rem; text-align: center; border: 1px solid #dee2e6;">üü¢ Verde</th>
                <th style="padding: 1rem; text-align: center; border: 1px solid #dee2e6;">üü° Amarela</th>
                <th style="padding: 1rem; text-align: center; border: 1px solid #dee2e6;">üî¥ Vermelha</th>
                <th style="padding: 1rem; text-align: center; border: 1px solid #dee2e6;">‚ö™ Ocioso</th>
                <th style="padding: 1rem; text-align: center; border: 1px solid #dee2e6;">Score</th>
              </tr>
            </thead>
            <tbody>
              {% for item in motoristas_performance %}
              <tr style="background: {% cycle '#f8f9fa' 'white' %}; transition: all 0.3s ease;" onmouseover="this.style.background='#e3f2fd'" onmouseout="this.style.background='{% cycle '#f8f9fa' 'white' %}'">
                <td style="padding: 1rem; text-align: center; border: 1px solid #dee2e6; font-weight: 700; font-size: 1.2rem;">
                  {% if forloop.counter == 1 %}
                    ü•á
                  {% elif forloop.counter == 2 %}
                    ü•à
                  {% elif forloop.counter == 3 %}
                    ü•â
                  {% else %}
                    {{ forloop.counter }}
                  {% endif %}
                </td>
                <td style="padding: 1rem; border: 1px solid #dee2e6;">
                  <div style="font-weight: 600; color: #667eea;">
                    {{ item.motorista.nm|default:item.motorista.id }}
                  </div>
                  <div style="font-size: 0.85rem; color: #666;">
                    {{ item.motorista.empresa.nome|default:"-" }}
                  </div>
                </td>
                <td style="padding: 1rem; text-align: center; border: 1px solid #dee2e6; font-weight: 600;">
                  {{ item.total_veiculos }}
                </td>
                <td style="padding: 1rem; text-align: center; border: 1px solid #dee2e6; font-weight: 600;">
                  {{ item.total_pontos }}
                </td>
                <td style="padding: 1rem; text-align: center; border: 1px solid #dee2e6; font-weight: 600;">
                  {{ item.rpm_medio|floatformat:0 }}
                </td>
                <td style="padding: 1rem; text-align: center; border: 1px solid #dee2e6; font-weight: 600;">
                  {{ item.velocidade_media|floatformat:0 }} km/h
                </td>
                <td style="padding: 1rem; text-align: center; border: 1px solid #dee2e6;">
                  <div style="font-weight: 600; color: #2196F3; font-size: 1.1rem;">
                    {{ item.perc_azul|floatformat:1 }}%
                  </div>
                  <div style="font-size: 0.85rem; color: #666;">
                    ({{ item.faixa_azul }})
                  </div>
                </td>
                <td style="padding: 1rem; text-align: center; border: 1px solid #dee2e6;">
                  <div style="font-weight: 600; color: #4CAF50; font-size: 1.1rem;">
                    {{ item.perc_verde|floatformat:1 }}%
                  </div>
                  <div style="font-size: 0.85rem; color: #666;">
                    ({{ item.faixa_verde }})
                  </div>
                </td>
                <td style="padding: 1rem; text-align: center; border: 1px solid #dee2e6;">
                  <div style="font-weight: 600; color: #FF9800; font-size: 1.1rem;">
                    {{ item.perc_amarela|floatformat:1 }}%
                  </div>
                  <div style="font-size: 0.85rem; color: #666;">
                    ({{ item.faixa_amarela }})
                  </div>
                </td>
                <td style="padding: 1rem; text-align: center; border: 1px solid #dee2e6;">
                  <div style="font-weight: 600; color: #f44336; font-size: 1.1rem;">
                    {{ item.perc_vermelha|floatformat:1 }}%
                  </div>
                  <div style="font-size: 0.85rem; color: #666;">
                    ({{ item.faixa_vermelha }})
                  </div>
                </td>
                <td style="padding: 1rem; text-align: center; border: 1px solid #dee2e6;">
                  <div style="font-weight: 600; color: #6c757d; font-size: 1.1rem;">
                    {{ item.perc_ocioso|floatformat:1 }}%
                  </div>
                  <div style="font-size: 0.85rem; color: #666;">
                    ({{ item.motor_ocioso }})
                  </div>
                </td>
                <td style="padding: 1rem; text-align: center; border: 1px solid #dee2e6;">
                  <div style="padding: 0.5rem 1rem; border-radius: 20px; font-weight: 700; font-size: 1.1rem;
                    {% if item.score >= 70 %}
                      background: linear-gradient(135deg, #4CAF50, #8BC34A); color: white;
                    {% elif item.score >= 40 %}
                      background: linear-gradient(135deg, #FF9800, #FFC107); color: white;
                    {% else %}
                      background: linear-gradient(135deg, #f44336, #e91e63); color: white;
                    {% endif %}
                  ">
                    {{ item.score|floatformat:1 }}
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      {% else %}
      <div style="background: white; border-radius: 15px; padding: 3rem; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.1);">
        <div style="font-size: 4rem; margin-bottom: 1rem;">ÔøΩ‚Äç‚úàÔ∏è</div>
        <h3 style="color: #6c757d; margin-bottom: 1rem;">Nenhum motorista com dados dispon√≠veis</h3>
        <p style="color: #6c757d;">
          N√£o h√° dados de performance de motoristas no sistema para o per√≠odo selecionado.
          <br>Verifique se h√° dados de Viagem_eco com motoristas associados.
        </p>
      </div>
      {% endif %}

      <!-- Gr√°fico de Linha Temporal - Evolu√ß√£o Di√°ria -->
      {% if evolucao_temporal %}
      <div class="chart-card" style="margin-top: 3rem; background-color: #ffffff;">
        <h2 style="text-align: center; margin-bottom: 1rem; color: #764ba2;">
          üìà Evolu√ß√£o Temporal do Score ({{ data_inicio }} at√© {{ data_fim }})
        </h2>
        <p style="text-align: center; color: #666; margin-bottom: 2rem;">
          Acompanhe a evolu√ß√£o di√°ria das m√©tricas de performance ao longo do per√≠odo selecionado
        </p>
        
        <div style="margin-bottom: 1.5rem; text-align: center; display: flex; flex-wrap: wrap; justify-content: center; gap: 1rem;">
          <button onclick="toggleLineDataset(0)" class="toggle-btn-line active" data-index="0" style="background: #4CAF50; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s;">
            üìä Score
          </button>
          <button onclick="toggleLineDataset(1)" class="toggle-btn-line active" data-index="1" style="background: #10b981; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s;">
            üü¢ Verde
          </button>
          <button onclick="toggleLineDataset(2)" class="toggle-btn-line active" data-index="2" style="background: #dc2626; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s;">
            üî¥ Vermelha
          </button>
          <button onclick="toggleLineDataset(3)" class="toggle-btn-line active" data-index="3" style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s;">
            üîµ Azul
          </button>
          <button onclick="toggleLineDataset(4)" class="toggle-btn-line active" data-index="4" style="background: #f59e0b; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s;">
            üü° Amarela
          </button>
          <button onclick="toggleLineDataset(5)" class="toggle-btn-line active" data-index="5" style="background: #6b7280; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s;">
            ‚è∏Ô∏è Ocioso
          </button>
          <button onclick="toggleLineDataset(6)" class="toggle-btn-line active" data-index="6" style="background: #8b5cf6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s;">
            üéØ RPM M√©dio
          </button>
          <button onclick="toggleLineDataset(7)" class="toggle-btn-line active" data-index="7" style="background: #ec4899; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s;">
            üöó Velocidade
          </button>
          <button onclick="toggleAllLineDatasets()" style="background: #1f2937; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s;">
            üîÑ Todos
          </button>
        </div>

        <canvas id="chartEvolucaoTemporal" style="max-height: 500px;"></canvas>
        
        <div style="margin-top: 1.5rem; padding: 1rem; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #764ba2;">
          <h4 style="margin: 0 0 0.5rem 0; color: #764ba2;">üí° Interpreta√ß√£o do Gr√°fico</h4>
          <ul style="margin: 0; padding-left: 1.5rem; color: #666;">
            <li><strong>Score:</strong> Linha principal que resume a performance geral do dia</li>
            <li><strong>Faixas de RPM:</strong> Percentuais di√°rios de cada faixa de rota√ß√£o</li>
            <li><strong>RPM M√©dio:</strong> Rota√ß√£o m√©dia di√°ria dos ve√≠culos</li>
            <li><strong>Velocidade:</strong> Velocidade m√©dia di√°ria</li>
            <li><strong>Tend√™ncias:</strong> Score crescente indica melhora na condu√ß√£o ao longo do tempo</li>
          </ul>
        </div>
      </div>

      <script>
      // Preparar dados para gr√°fico de evolu√ß√£o temporal
      const evolucaoTemporalData = [
        {% for dia in evolucao_temporal %}
        {
          data: '{{ dia.data }}',
          score: {{ dia.score }},
          perc_verde: {{ dia.perc_verde }},
          perc_vermelha: {{ dia.perc_vermelha }},
          perc_azul: {{ dia.perc_azul }},
          perc_amarela: {{ dia.perc_amarela }},
          perc_ocioso: {{ dia.perc_ocioso }},
          rpm_medio: {{ dia.rpm_medio }},
          velocidade_media: {{ dia.velocidade_media }},
          total_pontos: {{ dia.total_pontos }}
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
      ];

      console.log('üìä Dados de Evolu√ß√£o Temporal carregados:', evolucaoTemporalData.length, 'dias');
      console.log('üìÖ Per√≠odo:', evolucaoTemporalData[0]?.data, 'at√©', evolucaoTemporalData[evolucaoTemporalData.length-1]?.data);

      // Criar gr√°fico de linha temporal
      const ctxTemporal = document.getElementById('chartEvolucaoTemporal').getContext('2d');
      const chartTemporal = new Chart(ctxTemporal, {
        type: 'line',
        data: {
          labels: evolucaoTemporalData.map(d => d.data),
          datasets: [
            {
              label: 'Score',
              data: evolucaoTemporalData.map(d => d.score),
              borderColor: '#4CAF50',
              backgroundColor: 'rgba(76, 175, 80, 0.1)',
              borderWidth: 3,
              tension: 0.4,
              fill: true,
              pointRadius: 5,
              pointHoverRadius: 7,
              yAxisID: 'y'
            },
            {
              label: '% Verde',
              data: evolucaoTemporalData.map(d => d.perc_verde),
              borderColor: '#10b981',
              backgroundColor: 'rgba(16, 185, 129, 0.1)',
              borderWidth: 2,
              tension: 0.4,
              fill: false,
              pointRadius: 4,
              pointHoverRadius: 6,
              yAxisID: 'y1'
            },
            {
              label: '% Vermelha',
              data: evolucaoTemporalData.map(d => d.perc_vermelha),
              borderColor: '#dc2626',
              backgroundColor: 'rgba(220, 38, 38, 0.1)',
              borderWidth: 2,
              tension: 0.4,
              fill: false,
              pointRadius: 4,
              pointHoverRadius: 6,
              yAxisID: 'y1'
            },
            {
              label: '% Azul',
              data: evolucaoTemporalData.map(d => d.perc_azul),
              borderColor: '#3b82f6',
              backgroundColor: 'rgba(59, 130, 246, 0.1)',
              borderWidth: 2,
              tension: 0.4,
              fill: false,
              pointRadius: 4,
              pointHoverRadius: 6,
              yAxisID: 'y1'
            },
            {
              label: '% Amarela',
              data: evolucaoTemporalData.map(d => d.perc_amarela),
              borderColor: '#f59e0b',
              backgroundColor: 'rgba(245, 158, 11, 0.1)',
              borderWidth: 2,
              tension: 0.4,
              fill: false,
              pointRadius: 4,
              pointHoverRadius: 6,
              yAxisID: 'y1'
            },
            {
              label: '% Ocioso',
              data: evolucaoTemporalData.map(d => d.perc_ocioso),
              borderColor: '#6b7280',
              backgroundColor: 'rgba(107, 114, 128, 0.1)',
              borderWidth: 2,
              tension: 0.4,
              fill: false,
              pointRadius: 4,
              pointHoverRadius: 6,
              yAxisID: 'y1'
            },
            {
              label: 'RPM M√©dio',
              data: evolucaoTemporalData.map(d => d.rpm_medio),
              borderColor: '#8b5cf6',
              backgroundColor: 'rgba(139, 92, 246, 0.1)',
              borderWidth: 2,
              tension: 0.4,
              fill: false,
              pointRadius: 4,
              pointHoverRadius: 6,
              yAxisID: 'y2',
              hidden: true
            },
            {
              label: 'Velocidade M√©dia',
              data: evolucaoTemporalData.map(d => d.velocidade_media),
              borderColor: '#ec4899',
              backgroundColor: 'rgba(236, 72, 153, 0.1)',
              borderWidth: 2,
              tension: 0.4,
              fill: false,
              pointRadius: 4,
              pointHoverRadius: 6,
              yAxisID: 'y2',
              hidden: true
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          interaction: {
            mode: 'index',
            intersect: false,
          },
          plugins: {
            title: {
              display: false
            },
            legend: {
              display: true,
              position: 'bottom',
              labels: {
                usePointStyle: true,
                padding: 15,
                font: {
                  size: 12,
                  weight: '500'
                }
              }
            },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              padding: 12,
              titleFont: {
                size: 14,
                weight: 'bold'
              },
              bodyFont: {
                size: 13
              },
              callbacks: {
                title: function(context) {
                  const idx = context[0].dataIndex;
                  return 'üìÖ ' + evolucaoTemporalData[idx].data + ' (' + evolucaoTemporalData[idx].total_pontos.toLocaleString() + ' pontos)';
                },
                label: function(context) {
                  let label = context.dataset.label || '';
                  if (label) {
                    label += ': ';
                  }
                  if (context.parsed.y !== null) {
                    if (label.includes('%') || label.includes('Verde') || label.includes('Vermelha') || label.includes('Azul') || label.includes('Amarela') || label.includes('Ocioso')) {
                      label += context.parsed.y.toFixed(1) + '%';
                    } else if (label.includes('RPM')) {
                      label += context.parsed.y.toFixed(0) + ' rpm';
                    } else if (label.includes('Velocidade')) {
                      label += context.parsed.y.toFixed(1) + ' km/h';
                    } else {
                      label += context.parsed.y.toFixed(2);
                    }
                  }
                  return label;
                }
              }
            }
          },
          scales: {
            x: {
              display: true,
              title: {
                display: true,
                text: 'Data',
                font: {
                  size: 14,
                  weight: 'bold'
                }
              },
              grid: {
                display: false
              },
              ticks: {
                maxRotation: 45,
                minRotation: 45,
                font: {
                  size: 11
                }
              }
            },
            y: {
              type: 'linear',
              display: true,
              position: 'left',
              title: {
                display: true,
                text: 'Score',
                color: '#4CAF50',
                font: {
                  size: 14,
                  weight: 'bold'
                }
              },
              grid: {
                color: 'rgba(0, 0, 0, 0.05)'
              }
            },
            y1: {
              type: 'linear',
              display: true,
              position: 'right',
              title: {
                display: true,
                text: 'Percentual (%)',
                color: '#666',
                font: {
                  size: 14,
                  weight: 'bold'
                }
              },
              min: 0,
              max: 100,
              grid: {
                drawOnChartArea: false
              }
            },
            y2: {
              type: 'linear',
              display: false,
              position: 'right',
              title: {
                display: true,
                text: 'RPM / km/h',
                color: '#8b5cf6',
                font: {
                  size: 14,
                  weight: 'bold'
                }
              },
              grid: {
                drawOnChartArea: false
              }
            }
          }
        }
      });

      // Fun√ß√µes de toggle para gr√°fico temporal
      function toggleLineDataset(index) {
        const meta = chartTemporal.getDatasetMeta(index);
        meta.hidden = meta.hidden === null ? !chartTemporal.data.datasets[index].hidden : null;
        
        // Atualizar visual do bot√£o
        const btn = document.querySelector(`.toggle-btn-line[data-index="${index}"]`);
        if (meta.hidden) {
          btn.classList.remove('active');
          btn.style.opacity = '0.4';
          btn.style.transform = 'scale(0.95)';
        } else {
          btn.classList.add('active');
          btn.style.opacity = '1';
          btn.style.transform = 'scale(1)';
        }
        
        // Mostrar/ocultar eixo Y2 se RPM ou Velocidade est√£o ativos
        const rpmVisible = !chartTemporal.getDatasetMeta(6).hidden;
        const velVisible = !chartTemporal.getDatasetMeta(7).hidden;
        chartTemporal.options.scales.y2.display = rpmVisible || velVisible;
        
        chartTemporal.update();
      }

      function toggleAllLineDatasets() {
        const anyVisible = chartTemporal.data.datasets.some((dataset, index) => 
          !chartTemporal.getDatasetMeta(index).hidden
        );
        
        chartTemporal.data.datasets.forEach((dataset, index) => {
          const meta = chartTemporal.getDatasetMeta(index);
          meta.hidden = anyVisible ? true : null;
          
          const btn = document.querySelector(`.toggle-btn-line[data-index="${index}"]`);
          if (btn) {
            if (anyVisible) {
              btn.classList.remove('active');
              btn.style.opacity = '0.4';
              btn.style.transform = 'scale(0.95)';
            } else {
              btn.classList.add('active');
              btn.style.opacity = '1';
              btn.style.transform = 'scale(1)';
            }
          }
        });
        
        chartTemporal.options.scales.y2.display = !anyVisible;
        chartTemporal.update();
      }
      </script>
      {% endif %}

    </main>
    
    <footer class="footer">
      <p>&copy; 2025 Umbrella360. Transformando o Brasil atrav√©s da log√≠stica inteligente.</p>
      <p><em>"N√≥s enxergamos um mundo mais justo, mais humano e mais sustent√°vel."</em></p>
    </footer>

    <style>
    /* Estilos adicionais para responsividade */
    @media (max-width: 768px) {
      main {
        padding: 1rem !important;
      }
      
      .stats-grid {
        grid-template-columns: 1fr !important;
      }
      
      table {
        font-size: 0.75rem !important;
      }
      
      th, td {
        padding: 0.5rem !important;
      }
    }

    /* Anima√ß√µes de hover para cards */
    .stat-card {
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.2);
    }

    /* Estilo para links na tabela */
    .sortable-table a {
      transition: color 0.3s ease;
    }
    
    .sortable-table a:hover {
      color: #764ba2 !important;
      text-decoration: underline;
    }

    /* Estilos para bot√µes de toggle */
    button[id^="toggle"] {
      transition: all 0.3s ease !important;
    }
    
    button[id^="toggle"]:hover {
      transform: translateY(-2px) !important;
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3) !important;
    }
    
    button[id^="toggle"]:active {
      transform: translateY(0) !important;
    }
    </style>
    <script>
    // Fun√ß√£o para mostrar/ocultar campos de data personalizada
    function toggleDateInputs(value) {
      const dataInicioDiv = document.getElementById('dataInicioDiv');
      const dataFimDiv = document.getElementById('dataFimDiv');
      
      if (value === 'personalizado') {
        dataInicioDiv.style.display = 'block';
        dataFimDiv.style.display = 'block';
      } else {
        dataInicioDiv.style.display = 'none';
        dataFimDiv.style.display = 'none';
        // Limpar valores se n√£o for personalizado
        document.getElementById('data_inicio').value = '';
        document.getElementById('data_fim').value = '';
      }
    }
    
    // Aplicar estilo hover aos bot√µes
    document.querySelectorAll('button, a[href*="performance"]').forEach(el => {
      el.addEventListener('mouseenter', function() {
        this.style.transform = 'translateY(-2px)';
      });
      el.addEventListener('mouseleave', function() {
        this.style.transform = 'translateY(0)';
      });
    });
  </script>

  <script>
    {% if motoristas_performance %}
    // Preparar dados dos motoristas
    const motoristasData = [
      {% for item in motoristas_performance %}
      {
        nome: "{{ item.motorista.nm|default:item.motorista.id|escapejs }}",
        perc_verde: {{ item.perc_verde }},
        perc_vermelha: {{ item.perc_vermelha }},
        perc_azul: {{ item.perc_azul }},
        perc_amarela: {{ item.perc_amarela }},
        perc_ocioso: {{ item.perc_ocioso }},
        rpm_medio: {{ item.rpm_medio }},
        score: {{ item.score }},
        total_pontos: {{ item.total_pontos }}
      }{% if not forloop.last %},{% endif %}
      {% endfor %}
    ];

    // Fun√ß√£o para calcular correla√ß√£o de Pearson
    function calcularCorrelacao(arrayX, arrayY) {
      const n = arrayX.length;
      if (n === 0) return 0;
      
      const somaX = arrayX.reduce((a, b) => a + b, 0);
      const somaY = arrayY.reduce((a, b) => a + b, 0);
      const somaXY = arrayX.reduce((sum, x, i) => sum + x * arrayY[i], 0);
      const somaX2 = arrayX.reduce((sum, x) => sum + x * x, 0);
      const somaY2 = arrayY.reduce((sum, y) => sum + y * y, 0);
      
      const numerador = (n * somaXY) - (somaX * somaY);
      const denominador = Math.sqrt(((n * somaX2) - (somaX * somaX)) * ((n * somaY2) - (somaY * somaY)));
      
      return denominador === 0 ? 0 : numerador / denominador;
    }

    // Fun√ß√£o para formatar correla√ß√£o
    function formatarCorrelacao(r) {
      const abs = Math.abs(r);
      const forca = abs > 0.7 ? 'Forte' : abs > 0.4 ? 'Moderada' : 'Fraca';
      const direcao = r > 0 ? 'Positiva' : 'Negativa';
      return `r = ${r.toFixed(3)} (${forca} ${direcao})`;
    }

    // Preparar todos os datasets
    const allDatasets = [
      {
        label: 'üü¢ % Faixa Verde',
        data: motoristasData.map(m => ({ x: m.perc_verde, y: m.score })),
        backgroundColor: 'rgba(76, 175, 80, 0.6)',
        borderColor: 'rgba(76, 175, 80, 1)',
        borderWidth: 2,
        pointRadius: 6,
        pointHoverRadius: 8,
        hidden: false,
        dataKey: 'perc_verde'
      },
      {
        label: 'üî¥ % Faixa Vermelha',
        data: motoristasData.map(m => ({ x: m.perc_vermelha, y: m.score })),
        backgroundColor: 'rgba(244, 67, 54, 0.6)',
        borderColor: 'rgba(244, 67, 54, 1)',
        borderWidth: 2,
        pointRadius: 6,
        pointHoverRadius: 8,
        hidden: false,
        dataKey: 'perc_vermelha'
      },
      {
        label: 'üîµ % Faixa Azul',
        data: motoristasData.map(m => ({ x: m.perc_azul, y: m.score })),
        backgroundColor: 'rgba(33, 150, 243, 0.6)',
        borderColor: 'rgba(33, 150, 243, 1)',
        borderWidth: 2,
        pointRadius: 6,
        pointHoverRadius: 8,
        hidden: true,
        dataKey: 'perc_azul'
      },
      {
        label: 'üü° % Faixa Amarela',
        data: motoristasData.map(m => ({ x: m.perc_amarela, y: m.score })),
        backgroundColor: 'rgba(255, 152, 0, 0.6)',
        borderColor: 'rgba(255, 152, 0, 1)',
        borderWidth: 2,
        pointRadius: 6,
        pointHoverRadius: 8,
        hidden: true,
        dataKey: 'perc_amarela'
      },
      {
        label: '‚öôÔ∏è RPM M√©dio',
        data: motoristasData.map(m => ({ x: m.rpm_medio, y: m.score })),
        backgroundColor: 'rgba(102, 126, 234, 0.6)',
        borderColor: 'rgba(102, 126, 234, 1)',
        borderWidth: 2,
        pointRadius: 6,
        pointHoverRadius: 8,
        hidden: true,
        dataKey: 'rpm_medio'
      },
      {
        label: '‚ö™ % Ociosidade',
        data: motoristasData.map(m => ({ x: m.perc_ocioso, y: m.score })),
        backgroundColor: 'rgba(108, 117, 125, 0.6)',
        borderColor: 'rgba(108, 117, 125, 1)',
        borderWidth: 2,
        pointRadius: 6,
        pointHoverRadius: 8,
        hidden: true,
        dataKey: 'perc_ocioso'
      }
    ];

    // Calcular correla√ß√µes
    const correlacoes = [
      calcularCorrelacao(motoristasData.map(m => m.perc_verde), motoristasData.map(m => m.score)),
      calcularCorrelacao(motoristasData.map(m => m.perc_vermelha), motoristasData.map(m => m.score)),
      calcularCorrelacao(motoristasData.map(m => m.perc_azul), motoristasData.map(m => m.score)),
      calcularCorrelacao(motoristasData.map(m => m.perc_amarela), motoristasData.map(m => m.score)),
      calcularCorrelacao(motoristasData.map(m => m.rpm_medio), motoristasData.map(m => m.score)),
      calcularCorrelacao(motoristasData.map(m => m.perc_ocioso), motoristasData.map(m => m.score))
    ];

    // Exibir correla√ß√µes
    document.getElementById('correlVerdeScore').textContent = formatarCorrelacao(correlacoes[0]);
    document.getElementById('correlVermelhaScore').textContent = formatarCorrelacao(correlacoes[1]);
    document.getElementById('correlAzulScore').textContent = formatarCorrelacao(correlacoes[2]);
    document.getElementById('correlAmarelaScore').textContent = formatarCorrelacao(correlacoes[3]);
    document.getElementById('correlRPMScore').textContent = formatarCorrelacao(correlacoes[4]);
    document.getElementById('correlOciosoScore').textContent = formatarCorrelacao(correlacoes[5]);

    // Criar gr√°fico unificado
    const chartUnificado = new Chart(document.getElementById('chartUnificado'), {
      type: 'scatter',
      data: {
        datasets: allDatasets
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: true,
            position: 'top',
            labels: {
              font: {
                size: 12,
                weight: 'bold'
              },
              usePointStyle: true,
              padding: 15
            }
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                const motorista = motoristasData[context.dataIndex];
                const dataset = context.dataset;
                return [
                  `Motorista: ${motorista.nome}`,
                  `${dataset.label}: ${context.parsed.x.toFixed(1)}`,
                  `Score: ${context.parsed.y.toFixed(1)}`,
                  `Pontos: ${motorista.total_pontos}`
                ];
              }
            },
            backgroundColor: 'rgba(0, 0, 0, 0.8)',
            titleFont: { size: 14, weight: 'bold' },
            bodyFont: { size: 13 },
            padding: 12,
            cornerRadius: 8
          }
        },
        scales: {
          x: {
            title: {
              display: true,
              text: 'Valor da M√©trica',
              font: {
                size: 14,
                weight: 'bold'
              }
            },
            grid: {
              color: 'rgba(0, 0, 0, 0.08)'
            }
          },
          y: {
            title: {
              display: true,
              text: 'Score de Performance',
              font: {
                size: 14,
                weight: 'bold'
              }
            },
            grid: {
              color: 'rgba(0, 0, 0, 0.08)'
            }
          }
        }
      }
    });

    // Fun√ß√£o para toggle de datasets individuais
    function toggleDataset(index) {
      const meta = chartUnificado.getDatasetMeta(index);
      meta.hidden = !meta.hidden;
      chartUnificado.update();
      
      // Atualizar estilo do bot√£o
      const buttons = [
        'toggleVerdeBtn', 'toggleVermelhaBtn', 'toggleAzulBtn', 
        'toggleAmarelaBtn', 'toggleRPMBtn', 'toggleOciosoBtn'
      ];
      const btn = document.getElementById(buttons[index]);
      if (meta.hidden) {
        btn.style.opacity = '0.4';
        btn.style.transform = 'scale(0.95)';
      } else {
        btn.style.opacity = '1';
        btn.style.transform = 'scale(1)';
      }
    }

    // Fun√ß√£o para toggle de todos os datasets
    function toggleAllDatasets() {
      const allHidden = chartUnificado.data.datasets.every((_, i) => 
        chartUnificado.getDatasetMeta(i).hidden
      );
      
      chartUnificado.data.datasets.forEach((_, i) => {
        chartUnificado.getDatasetMeta(i).hidden = !allHidden;
      });
      chartUnificado.update();
      
      // Atualizar estilos dos bot√µes
      const buttons = [
        'toggleVerdeBtn', 'toggleVermelhaBtn', 'toggleAzulBtn', 
        'toggleAmarelaBtn', 'toggleRPMBtn', 'toggleOciosoBtn'
      ];
      buttons.forEach((btnId, i) => {
        const btn = document.getElementById(btnId);
        const hidden = chartUnificado.getDatasetMeta(i).hidden;
        btn.style.opacity = hidden ? '0.4' : '1';
        btn.style.transform = hidden ? 'scale(0.95)' : 'scale(1)';
      });
    }

    // Inicializar estilos dos bot√µes
    window.addEventListener('load', function() {
      const buttons = [
        'toggleVerdeBtn', 'toggleVermelhaBtn', 'toggleAzulBtn', 
        'toggleAmarelaBtn', 'toggleRPMBtn', 'toggleOciosoBtn'
      ];
      buttons.forEach((btnId, i) => {
        const btn = document.getElementById(btnId);
        const hidden = chartUnificado.getDatasetMeta(i).hidden;
        btn.style.opacity = hidden ? '0.4' : '1';
        btn.style.transform = hidden ? 'scale(0.95)' : 'scale(1)';
      });
    });

    // ==================== NOVOS GR√ÅFICOS ANAL√çTICOS ====================

    // Preparar dados para Top 10
    const top10Motoristas = motoristasData.slice(0, 10);

    // GR√ÅFICO 1: Pizza - Distribui√ß√£o das Faixas de RPM
    const totalPontos = motoristasData.reduce((sum, m) => sum + m.total_pontos, 0);
    const totalAzul = motoristasData.reduce((sum, m) => sum + (m.perc_azul * m.total_pontos / 100), 0);
    const totalVerde = motoristasData.reduce((sum, m) => sum + (m.perc_verde * m.total_pontos / 100), 0);
    const totalAmarela = motoristasData.reduce((sum, m) => sum + (m.perc_amarela * m.total_pontos / 100), 0);
    const totalVermelha = motoristasData.reduce((sum, m) => sum + (m.perc_vermelha * m.total_pontos / 100), 0);
    const totalOcioso = motoristasData.reduce((sum, m) => sum + (m.perc_ocioso * m.total_pontos / 100), 0);

    new Chart(document.getElementById('chartPizzaFaixas'), {
      type: 'doughnut',
      data: {
        labels: ['üîµ Azul (Econ√¥mica)', 'üü¢ Verde (Ideal)', 'üü° Amarela (Aten√ß√£o)', 'üî¥ Vermelha (Cr√≠tica)', '‚ö™ Ocioso'],
        datasets: [{
          data: [
            (totalAzul / totalPontos * 100).toFixed(1),
            (totalVerde / totalPontos * 100).toFixed(1),
            (totalAmarela / totalPontos * 100).toFixed(1),
            (totalVermelha / totalPontos * 100).toFixed(1),
            (totalOcioso / totalPontos * 100).toFixed(1)
          ],
          backgroundColor: [
            'rgba(33, 150, 243, 0.8)',
            'rgba(76, 175, 80, 0.8)',
            'rgba(255, 152, 0, 0.8)',
            'rgba(244, 67, 54, 0.8)',
            'rgba(108, 117, 125, 0.8)'
          ],
          borderColor: [
            'rgba(33, 150, 243, 1)',
            'rgba(76, 175, 80, 1)',
            'rgba(255, 152, 0, 1)',
            'rgba(244, 67, 54, 1)',
            'rgba(108, 117, 125, 1)'
          ],
          borderWidth: 2
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
              font: { size: 12, weight: 'bold' },
              padding: 15,
              usePointStyle: true
            }
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                return `${context.label}: ${context.parsed}%`;
              }
            }
          }
        }
      }
    });

    // GR√ÅFICO 2: Barras Horizontais - Top 10 por Score
    new Chart(document.getElementById('chartTop10Score'), {
      type: 'bar',
      data: {
        labels: top10Motoristas.map(m => m.nome.substring(0, 15) + (m.nome.length > 15 ? '...' : '')),
        datasets: [{
          label: 'Score de Performance',
          data: top10Motoristas.map(m => m.score),
          backgroundColor: top10Motoristas.map(m => {
            if (m.score >= 70) return 'rgba(76, 175, 80, 0.8)';
            if (m.score >= 40) return 'rgba(255, 152, 0, 0.8)';
            return 'rgba(244, 67, 54, 0.8)';
          }),
          borderColor: top10Motoristas.map(m => {
            if (m.score >= 70) return 'rgba(76, 175, 80, 1)';
            if (m.score >= 40) return 'rgba(255, 152, 0, 1)';
            return 'rgba(244, 67, 54, 1)';
          }),
          borderWidth: 2
        }]
      },
      options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: function(context) {
                const motorista = top10Motoristas[context.dataIndex];
                return [
                  `Score: ${context.parsed.x.toFixed(1)}`,
                  `Pontos: ${motorista.total_pontos}`,
                  `Verde: ${motorista.perc_verde.toFixed(1)}%`,
                  `Vermelha: ${motorista.perc_vermelha.toFixed(1)}%`
                ];
              }
            }
          }
        },
        scales: {
          x: {
            title: { display: true, text: 'Score', font: { size: 12, weight: 'bold' } },
            grid: { color: 'rgba(0, 0, 0, 0.05)' }
          },
          y: {
            grid: { display: false }
          }
        }
      }
    });

    // GR√ÅFICO 3: Barras Empilhadas - Composi√ß√£o de Faixas
    new Chart(document.getElementById('chartComposicaoFaixas'), {
      type: 'bar',
      data: {
        labels: top10Motoristas.map(m => m.nome.substring(0, 12) + (m.nome.length > 12 ? '...' : '')),
        datasets: [
          {
            label: 'üîµ Azul',
            data: top10Motoristas.map(m => m.perc_azul),
            backgroundColor: 'rgba(33, 150, 243, 0.8)',
            borderColor: 'rgba(33, 150, 243, 1)',
            borderWidth: 1
          },
          {
            label: 'üü¢ Verde',
            data: top10Motoristas.map(m => m.perc_verde),
            backgroundColor: 'rgba(76, 175, 80, 0.8)',
            borderColor: 'rgba(76, 175, 80, 1)',
            borderWidth: 1
          },
          {
            label: 'üü° Amarela',
            data: top10Motoristas.map(m => m.perc_amarela),
            backgroundColor: 'rgba(255, 152, 0, 0.8)',
            borderColor: 'rgba(255, 152, 0, 1)',
            borderWidth: 1
          },
          {
            label: 'üî¥ Vermelha',
            data: top10Motoristas.map(m => m.perc_vermelha),
            backgroundColor: 'rgba(244, 67, 54, 0.8)',
            borderColor: 'rgba(244, 67, 54, 1)',
            borderWidth: 1
          },
          {
            label: '‚ö™ Ocioso',
            data: top10Motoristas.map(m => m.perc_ocioso),
            backgroundColor: 'rgba(108, 117, 125, 0.8)',
            borderColor: 'rgba(108, 117, 125, 1)',
            borderWidth: 1
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'top',
            labels: {
              font: { size: 11, weight: 'bold' },
              padding: 12,
              usePointStyle: true
            }
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                return `${context.dataset.label}: ${context.parsed.y.toFixed(1)}%`;
              },
              footer: function(tooltipItems) {
                const index = tooltipItems[0].dataIndex;
                const motorista = top10Motoristas[index];
                return `Score: ${motorista.score.toFixed(1)}`;
              }
            }
          }
        },
        scales: {
          x: {
            stacked: true,
            grid: { display: false }
          },
          y: {
            stacked: true,
            title: { display: true, text: 'Percentual (%)', font: { size: 12, weight: 'bold' } },
            max: 100,
            grid: { color: 'rgba(0, 0, 0, 0.05)' }
          }
        }
      }
    });

    // GR√ÅFICO 4: Barras Agrupadas - RPM vs Velocidade
    new Chart(document.getElementById('chartRPMVelocidade'), {
      type: 'bar',
      data: {
        labels: top10Motoristas.map(m => m.nome.substring(0, 12) + (m.nome.length > 12 ? '...' : '')),
        datasets: [
          {
            label: '‚öôÔ∏è RPM M√©dio',
            data: top10Motoristas.map(m => m.rpm_medio),
            backgroundColor: 'rgba(102, 126, 234, 0.7)',
            borderColor: 'rgba(102, 126, 234, 1)',
            borderWidth: 2,
            yAxisID: 'y'
          },
          {
            label: 'üöó Velocidade M√©dia (km/h)',
            data: top10Motoristas.map(m => m.velocidade_media),
            backgroundColor: 'rgba(255, 87, 34, 0.7)',
            borderColor: 'rgba(255, 87, 34, 1)',
            borderWidth: 2,
            yAxisID: 'y1'
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'top',
            labels: {
              font: { size: 12, weight: 'bold' },
              padding: 15,
              usePointStyle: true
            }
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                const label = context.dataset.label;
                const value = context.parsed.y.toFixed(0);
                return `${label}: ${value}`;
              }
            }
          }
        },
        scales: {
          x: {
            grid: { display: false }
          },
          y: {
            type: 'linear',
            position: 'left',
            title: { display: true, text: 'RPM', font: { size: 12, weight: 'bold' }, color: 'rgba(102, 126, 234, 1)' },
            grid: { color: 'rgba(0, 0, 0, 0.05)' },
            ticks: { color: 'rgba(102, 126, 234, 1)' }
          },
          y1: {
            type: 'linear',
            position: 'right',
            title: { display: true, text: 'Velocidade (km/h)', font: { size: 12, weight: 'bold' }, color: 'rgba(255, 87, 34, 1)' },
            grid: { display: false },
            ticks: { color: 'rgba(255, 87, 34, 1)' }
          }
        }
      }
    });

    // GR√ÅFICO 5: Box Plot - Distribui√ß√£o Estat√≠stica
    // Preparar dados para Box Plot
    const metricas = {
      score: motoristasData.map(m => m.score),
      rpm: motoristasData.map(m => m.rpm_medio),
      velocidade: motoristasData.map(m => m.velocidade_media),
      perc_verde: motoristasData.map(m => m.perc_verde),
      perc_vermelha: motoristasData.map(m => m.perc_vermelha),
      perc_ocioso: motoristasData.map(m => m.perc_ocioso)
    };

    new Chart(document.getElementById('chartBoxPlot'), {
      type: 'boxplot',
      data: {
        labels: ['Score', 'RPM M√©dio', 'Velocidade (km/h)', '% Verde', '% Vermelha', '% Ocioso'],
        datasets: [{
          label: 'Distribui√ß√£o',
          data: [
            metricas.score,
            metricas.rpm,
            metricas.velocidade,
            metricas.perc_verde,
            metricas.perc_vermelha,
            metricas.perc_ocioso
          ],
          backgroundColor: [
            'rgba(102, 126, 234, 0.5)',
            'rgba(156, 39, 176, 0.5)',
            'rgba(255, 87, 34, 0.5)',
            'rgba(76, 175, 80, 0.5)',
            'rgba(244, 67, 54, 0.5)',
            'rgba(108, 117, 125, 0.5)'
          ],
          borderColor: [
            'rgba(102, 126, 234, 1)',
            'rgba(156, 39, 176, 1)',
            'rgba(255, 87, 34, 1)',
            'rgba(76, 175, 80, 1)',
            'rgba(244, 67, 54, 1)',
            'rgba(108, 117, 125, 1)'
          ],
          borderWidth: 2,
          outlierColor: [
            'rgba(244, 67, 54, 0.8)',
            'rgba(244, 67, 54, 0.8)',
            'rgba(244, 67, 54, 0.8)',
            'rgba(244, 67, 54, 0.8)',
            'rgba(244, 67, 54, 0.8)',
            'rgba(244, 67, 54, 0.8)'
          ],
          itemRadius: 4,
          itemBackgroundColor: 'rgba(244, 67, 54, 0.8)',
          itemBorderColor: 'rgba(244, 67, 54, 1)',
          outlierRadius: 5
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                const stats = context.parsed;
                return [
                  `M√≠nimo: ${stats.min.toFixed(1)}`,
                  `Q1 (25%): ${stats.q1.toFixed(1)}`,
                  `Mediana: ${stats.median.toFixed(1)}`,
                  `Q3 (75%): ${stats.q3.toFixed(1)}`,
                  `M√°ximo: ${stats.max.toFixed(1)}`,
                  `Outliers: ${stats.items ? stats.items.length : 0}`
                ];
              }
            },
            backgroundColor: 'rgba(0, 0, 0, 0.8)',
            titleFont: { size: 13, weight: 'bold' },
            bodyFont: { size: 12 },
            padding: 12
          }
        },
        scales: {
          x: {
            grid: { display: false },
            ticks: {
              font: { size: 11, weight: 'bold' }
            }
          },
          y: {
            title: {
              display: true,
              text: 'Valor da M√©trica',
              font: { size: 13, weight: 'bold' }
            },
            grid: {
              color: 'rgba(0, 0, 0, 0.05)'
            }
          }
        }
      }
    });

    // GR√ÅFICO 6: Heatmap - Matriz de Correla√ß√£o
    // Definir m√©tricas para an√°lise
    const metricasNomes = ['Score', 'RPM', 'Vel.', '% Verde', '% Azul', '% Amarela', '% Vermelha', '% Ocioso'];
    const metricasArrays = [
      motoristasData.map(m => m.score),
      motoristasData.map(m => m.rpm_medio),
      motoristasData.map(m => m.velocidade_media),
      motoristasData.map(m => m.perc_verde),
      motoristasData.map(m => m.perc_azul),
      motoristasData.map(m => m.perc_amarela),
      motoristasData.map(m => m.perc_vermelha),
      motoristasData.map(m => m.perc_ocioso)
    ];

    // Calcular matriz de correla√ß√£o
    const matrizCorrelacao = [];
    for (let i = 0; i < metricasArrays.length; i++) {
      for (let j = 0; j < metricasArrays.length; j++) {
        const corr = calcularCorrelacao(metricasArrays[i], metricasArrays[j]);
        matrizCorrelacao.push({
          x: metricasNomes[j],
          y: metricasNomes[i],
          v: corr
        });
      }
    }

    // Fun√ß√£o para gerar cor baseada na correla√ß√£o
    function getCorrelationColor(value) {
      // Normalizar entre 0 e 1 para usar no gradiente
      const normalized = (value + 1) / 2;
      
      if (value >= 0.5) {
        // Verde escuro para correla√ß√£o positiva forte
        const intensity = Math.floor((value - 0.5) * 2 * 255);
        return `rgba(27, ${94 + intensity}, 32, 0.9)`;
      } else if (value > 0) {
        // Verde claro para correla√ß√£o positiva fraca
        const intensity = Math.floor(value * 2 * 255);
        return `rgba(129, ${199 + (intensity * 0.2)}, 132, ${0.4 + value * 0.5})`;
      } else if (value === 0) {
        // Branco para sem correla√ß√£o
        return 'rgba(255, 255, 255, 0.9)';
      } else if (value > -0.5) {
        // Laranja/Amarelo para correla√ß√£o negativa fraca
        const intensity = Math.floor(Math.abs(value) * 2 * 255);
        return `rgba(255, ${152 - intensity * 0.5}, 0, ${0.4 + Math.abs(value) * 0.5})`;
      } else {
        // Vermelho para correla√ß√£o negativa forte
        const intensity = Math.floor((Math.abs(value) - 0.5) * 2 * 255);
        return `rgba(${211 + intensity * 0.2}, 47, 47, 0.9)`;
      }
    }

    new Chart(document.getElementById('chartHeatmap'), {
      type: 'matrix',
      data: {
        datasets: [{
          label: 'Correla√ß√£o',
          data: matrizCorrelacao,
          backgroundColor: function(context) {
            const value = context.dataset.data[context.dataIndex]?.v;
            return value !== undefined ? getCorrelationColor(value) : 'rgba(200, 200, 200, 0.3)';
          },
          borderColor: 'rgba(0, 0, 0, 0.1)',
          borderWidth: 1,
          width: ({chart}) => (chart.chartArea || {}).width / metricasNomes.length - 1,
          height: ({chart}) => (chart.chartArea || {}).height / metricasNomes.length - 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false
          },
          tooltip: {
            callbacks: {
              title: function() {
                return 'Correla√ß√£o';
              },
              label: function(context) {
                const v = context.dataset.data[context.dataIndex];
                const corrValue = v.v.toFixed(3);
                const forca = Math.abs(v.v) > 0.7 ? 'Forte' : Math.abs(v.v) > 0.4 ? 'Moderada' : 'Fraca';
                const direcao = v.v > 0 ? 'Positiva' : v.v < 0 ? 'Negativa' : 'Neutra';
                return [
                  `${v.y} √ó ${v.x}`,
                  `r = ${corrValue}`,
                  `${forca} ${direcao}`,
                  '',
                  v.v > 0.7 ? '‚úÖ Forte correla√ß√£o positiva' :
                  v.v > 0.4 ? 'üü¢ Correla√ß√£o positiva moderada' :
                  v.v > 0 ? 'üü° Fraca correla√ß√£o positiva' :
                  v.v === 0 ? '‚ö™ Sem correla√ß√£o' :
                  v.v > -0.4 ? 'üü† Fraca correla√ß√£o negativa' :
                  v.v > -0.7 ? 'üî¥ Correla√ß√£o negativa moderada' :
                  '‚ùå Forte correla√ß√£o negativa'
                ];
              }
            },
            backgroundColor: 'rgba(0, 0, 0, 0.85)',
            titleFont: { size: 13, weight: 'bold' },
            bodyFont: { size: 12 },
            padding: 12,
            cornerRadius: 8
          }
        },
        scales: {
          x: {
            type: 'category',
            labels: metricasNomes,
            offset: true,
            ticks: {
              font: { size: 11, weight: 'bold' }
            },
            grid: {
              display: false
            }
          },
          y: {
            type: 'category',
            labels: metricasNomes,
            offset: true,
            ticks: {
              font: { size: 11, weight: 'bold' }
            },
            grid: {
              display: false
            }
          }
        }
      }
    });

    {% endif %}
  </script>
  </body>
</html>