<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CheckPoints - {{ unidade.nm|default:unidade.id }} - Umbrella360</title>
    
    {% load static %}
    <link rel="stylesheet" href="{% static 'umbrella360/style.css' %}?v=9">
    <link rel="stylesheet" href="{% static 'umbrella360/style_refatorado.css' %}?v=2">
    <link rel="stylesheet" href="{% static 'umbrella360/theme-fixes.css' %}?v=1">
    <script src="{% static 'umbrella360/theme-toggle.js' %}?v=2"></script>
    
    <style>
      .cercas-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 2rem;
      }
      
      .cercas-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem;
        border-radius: 15px;
        margin-bottom: 2rem;
        text-align: center;
        box-shadow: 0 10px 40px rgba(0,0,0,0.1);
      }
      
      .cercas-header h1 {
        margin: 0 0 0.5rem 0;
        font-size: 2.2rem;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
      }
      
      .cercas-header p {
        margin: 0;
        font-size: 1.1rem;
        opacity: 0.9;
      }
      
      .stats-overview {
        background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        border-radius: 15px;
        padding: 2rem;
        margin-bottom: 2rem;
        border: 1px solid #dee2e6;
      }
      
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
      }
      
      .stat-card {
        background: white;
        padding: 1.5rem;
        border-radius: 10px;
        text-align: center;
        border: 1px solid #e9ecef;
        transition: transform 0.3s ease;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      }
      
      .stat-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(0,0,0,0.1);
      }
      
      .stat-value {
        font-size: 2.2rem;
        font-weight: 700;
        color: #2c3e50;
        margin: 0.5rem 0;
      }
      
      .stat-label {
        color: #6c757d;
        font-size: 0.9rem;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      
      .filter-section {
        background: rgba(255, 255, 255, 0.95);
        padding: 2rem;
        border-radius: 15px;
        margin-bottom: 2rem;
        border: 1px solid #dee2e6;
        box-shadow: 0 5px 20px rgba(0,0,0,0.08);
      }
      
      .filter-form {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
        align-items: end;
      }
      
      .filter-group {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }
      
      .filter-group label {
        font-weight: 600;
        color: #495057;
        font-size: 0.95rem;
      }
      
      .filter-group select,
      .filter-group input {
        padding: 0.75rem;
        border: 2px solid #ced4da;
        border-radius: 8px;
        background: white;
        color: #495057;
        font-size: 0.95rem;
        transition: all 0.3s ease;
      }
      
      .filter-group select:focus,
      .filter-group input:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.15);
      }
      
      .filter-actions {
        display: flex;
        gap: 1rem;
        align-items: end;
      }
      
      .btn-filter {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 8px;
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
        color: white;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-block;
        text-align: center;
      }
      
      .btn-filter:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        text-decoration: none;
        color: white;
      }
      
      .btn-clear {
        background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
      }
      
      .checkpoints-table-container {
        background: white;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 10px 40px rgba(0,0,0,0.08);
        border: 1px solid #dee2e6;
      }
      
      .checkpoints-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.95rem;
      }
      
      .checkpoints-table thead {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }
      
      .checkpoints-table thead th {
        padding: 1.2rem 1rem;
        text-align: left;
        font-weight: 600;
        letter-spacing: 0.5px;
        position: sticky;
        top: 0;
        z-index: 10;
      }
      
      .checkpoints-table tbody tr {
        transition: all 0.3s ease;
        border-bottom: 1px solid #e9ecef;
      }
      
      .checkpoints-table tbody tr:nth-child(even) {
        background: #f8f9fa;
      }
      
      .checkpoints-table tbody tr:hover {
        background: #e3f2fd;
        transform: scale(1.01);
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      }
      
      .checkpoints-table tbody td {
        padding: 1rem;
        border-right: 1px solid #f1f3f4;
        vertical-align: middle;
      }
      
      .checkpoint-cerca {
        background: linear-gradient(135deg, #e7f3ff, #cce7ff);
        color: #0066cc;
        padding: 0.4rem 0.8rem;
        border-radius: 6px;
        font-size: 0.875rem;
        font-weight: 500;
        display: inline-block;
        border: 1px solid #b3d9ff;
      }
      
      .checkpoint-status {
        padding: 0.3rem 0.7rem;
        border-radius: 15px;
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      
      .status-entrada {
        background: linear-gradient(135deg, #d4edda, #c3e6cb);
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      
      .status-saida {
        background: linear-gradient(135deg, #fff3cd, #ffeaa7);
        color: #856404;
        border: 1px solid #ffeaa7;
      }
      
      .status-ativa {
        background: linear-gradient(135deg, #cce5ff, #99d6ff);
        color: #004085;
        border: 1px solid #99d6ff;
      }
      
      .duracao-badge {
        background: linear-gradient(135deg, #e8f5e8, #d1edcc);
        color: #28a745;
        padding: 0.3rem 0.7rem;
        border-radius: 12px;
        font-size: 0.85rem;
        font-weight: 600;
        border: 1px solid #c3e6cb;
      }
      
      .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 0.5rem;
        margin: 2rem 0;
        padding: 1rem;
      }
      
      .pagination a,
      .pagination span {
        padding: 0.75rem 1rem;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        text-decoration: none;
        color: #495057;
        font-weight: 500;
        transition: all 0.3s ease;
      }
      
      .pagination a:hover {
        background: #007bff;
        color: white;
        border-color: #007bff;
        transform: translateY(-1px);
      }
      
      .pagination .current {
        background: #007bff;
        color: white;
        border-color: #007bff;
      }
      
      .no-data {
        text-align: center;
        padding: 4rem 2rem;
        color: #6c757d;
      }
      
      .no-data h3 {
        color: #495057;
        margin-bottom: 1rem;
      }
      
      @media (max-width: 768px) {
        .cercas-container {
          padding: 1rem;
        }
        
        .stats-grid {
          grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        }
        
        .filter-form {
          grid-template-columns: 1fr;
        }
        
        .checkpoints-table-container {
          overflow-x: auto;
        }
        
        .checkpoints-table {
          min-width: 800px;
        }
        
        .checkpoints-table thead th,
        .checkpoints-table tbody td {
          padding: 0.75rem 0.5rem;
          font-size: 0.85rem;
        }
      }
    </style>
  </head>
  <body>

    <!-- Bot√£o de altern√¢ncia de tema -->
    <button id="theme-toggle" class="theme-toggle" title="Alternar tema">
      <span class="theme-icon">‚óê</span> Noite de Ver√£o
    </button>

    <div class="header">
      <h1>CheckPoints da Unidade</h1>
      <p class="tagline">{{ unidade.nm|default:unidade.id }} - Hist√≥rico Completo</p>
      <div class="menu-buttons">
        <a href="{% url 'index' %}" class="btn btn-secondary">In√≠cio</a>
        <a href="{% url 'detalhes_unidade' unidade.id %}" class="btn btn-secondary">Voltar √† Unidade</a>
        <a href="{% url 'lista_unidades' %}" class="btn btn-secondary">Lista de Unidades</a>
        {% if request.session.empresa_nome %}
          <a href="{% url 'logout' %}" class="btn btn-secondary">Logout</a>
        {% endif %}
      </div>
    </div>

    <main class="cercas-container">
      
      <!-- Cabe√ßalho da Unidade -->
      <div class="cercas-header">
        <h1>CheckPoints - {{ unidade.nm|default:unidade.id }}</h1>
        <p>Hist√≥rico completo de passagens por cercas geogr√°ficas</p>
        {% if unidade.cls %}
          <small style="opacity: 0.8; font-size: 1rem; margin-top: 0.5rem; display: block;">
            Classifica√ß√£o: {{ unidade.cls }}
          </small>
        {% endif %}
      </div>

      <!-- Estat√≠sticas Gerais -->
      <div class="stats-overview">
        <h3 style="text-align: center; margin-bottom: 2rem; color: #2c3e50;">Resumo dos CheckPoints</h3>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value">{{ total_checkpoints }}</div>
            <div class="stat-label">Total de Passagens</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">{{ cercas_distintas }}</div>
            <div class="stat-label">Cercas Diferentes</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">{{ tempo_total_parado }}</div>
            <div class="stat-label">Tempo Total em Cercas</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">{{ media_permanencia }}</div>
            <div class="stat-label">Tempo M√©dio por Cerca</div>
          </div>
        </div>
      </div>

      <!-- Filtros -->
      <div class="filter-section">
        <h3 style="margin-bottom: 1.5rem; color: #2c3e50; text-align: center;">üîç Filtros de Busca</h3>
        <form method="get" class="filter-form">
          <div class="filter-group">
            <label for="cerca">Filtrar por Cerca:</label>
            <select name="cerca" id="cerca">
              <option value="">Todas as Cercas</option>
              {% for cerca_opcao in cercas_disponiveis %}
                <option value="{{ cerca_opcao }}" {% if cerca_selecionada == cerca_opcao %}selected{% endif %}>
                  {{ cerca_opcao }}
                </option>
              {% endfor %}
            </select>
          </div>
          
          <div class="filter-group">
            <label for="data_inicio">Data In√≠cio:</label>
            <input type="date" name="data_inicio" id="data_inicio" value="{{ data_inicio }}">
          </div>
          
          <div class="filter-group">
            <label for="data_fim">Data Fim:</label>
            <input type="date" name="data_fim" id="data_fim" value="{{ data_fim }}">
          </div>
          
          <div class="filter-group">
            <label for="tipo_evento">Tipo de Evento:</label>
            <select name="tipo_evento" id="tipo_evento">
              <option value="">Todos os Tipos</option>
              <option value="entrada" {% if tipo_evento == 'entrada' %}selected{% endif %}>Entrada</option>
              <option value="saida" {% if tipo_evento == 'saida' %}selected{% endif %}>Sa√≠da</option>
              <option value="permanencia" {% if tipo_evento == 'permanencia' %}selected{% endif %}>Perman√™ncia</option>
            </select>
          </div>
          
          <div class="filter-actions">
            <button type="submit" class="btn-filter">Aplicar Filtros</button>
            <a href="{% url 'cercas_unidade' unidade.id %}" class="btn-filter btn-clear">Limpar Filtros</a>
          </div>
        </form>
        
        <!-- Bot√µes de Exporta√ß√£o -->
        <div class="export-buttons" style="margin-top: 1.5rem; text-align: center; padding-top: 1.5rem; border-top: 1px solid #dee2e6;">
          <h4 style="margin-bottom: 1rem; color: #495057;">üì• Exportar Dados</h4>
          <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
            <a href="{% url 'export_cercas_excel' unidade.id %}{% if request.GET %}?{{ request.GET.urlencode }}{% endif %}" 
               class="btn-filter" 
               style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); text-decoration: none; display: inline-flex; align-items: center; gap: 0.5rem;"
               title="Exportar dados filtrados para Excel">
              Exportar Excel
            </a>
            <a href="{% url 'export_cercas_pdf' unidade.id %}{% if request.GET %}?{{ request.GET.urlencode }}{% endif %}" 
               class="btn-filter" 
               style="background: linear-gradient(135deg, #dc3545 0%, #e83e8c 100%); text-decoration: none; display: inline-flex; align-items: center; gap: 0.5rem;"
               title="Exportar dados filtrados para PDF">
              Exportar PDF
            </a>
          </div>
          <p style="margin-top: 0.75rem; color: #6c757d; font-size: 0.85rem;">
            üí° Os arquivos exportados respeitar√£o todos os filtros aplicados
          </p>
        </form>
      </div>

      <!-- Tabela de CheckPoints -->
      <div class="checkpoints-table-container">
        {% if checkpoints %}
          <table class="checkpoints-table">
            <thead>
              <tr>
                <th>Cerca</th>
                <th>Data/Hora Entrada</th>
                <th>Data/Hora Sa√≠da</th>
                <th>Dura√ß√£o</th>
                <th>Status</th>
                <th>Dia da Semana</th>
                <th>Per√≠odo</th>
              </tr>
            </thead>
            <tbody>
              {% for checkpoint in checkpoints %}
                <tr>
                  <td>
                    <span class="checkpoint-cerca">
                      {{ checkpoint.cerca|truncatechars:30 }}
                    </span>
                  </td>
                  <td>
                    {% if checkpoint.data_entrada %}
                      <strong>{{ checkpoint.data_entrada|date:"d/m/Y" }}</strong><br>
                      <small style="color: #6c757d;">{{ checkpoint.data_entrada|date:"H:i:s" }}</small>
                    {% else %}
                      <span style="color: #6c757d;">-</span>
                    {% endif %}
                  </td>
                  <td>
                    {% if checkpoint.data_saida %}
                      <strong>{{ checkpoint.data_saida|date:"d/m/Y" }}</strong><br>
                      <small style="color: #6c757d;">{{ checkpoint.data_saida|date:"H:i:s" }}</small>
                    {% else %}
                      <span class="checkpoint-status status-ativa">Em Andamento</span>
                    {% endif %}
                  </td>
                  <td>
                    {% if checkpoint.duracao %}
                      <span class="duracao-badge">{{ checkpoint.duracao }}</span>
                    {% else %}
                      <span style="color: #6c757d;">-</span>
                    {% endif %}
                  </td>
                  <td>
                    {% if checkpoint.data_saida %}
                      <span class="checkpoint-status status-saida">Finalizada</span>
                    {% elif checkpoint.data_entrada %}
                      <span class="checkpoint-status status-ativa">Ativa</span>
                    {% else %}
                      <span class="checkpoint-status status-entrada">Iniciada</span>
                    {% endif %}
                  </td>
                  <td>
                    {% if checkpoint.data_entrada %}
                      <span style="font-weight: 500; color: #495057;">
                        {% if checkpoint.data_entrada.weekday == 0 %}Segunda-feira
                        {% elif checkpoint.data_entrada.weekday == 1 %}Ter√ßa-feira
                        {% elif checkpoint.data_entrada.weekday == 2 %}Quarta-feira
                        {% elif checkpoint.data_entrada.weekday == 3 %}Quinta-feira
                        {% elif checkpoint.data_entrada.weekday == 4 %}Sexta-feira
                        {% elif checkpoint.data_entrada.weekday == 5 %}S√°bado
                        {% elif checkpoint.data_entrada.weekday == 6 %}Domingo
                        {% endif %}
                      </span>
                    {% else %}
                      <span style="color: #6c757d;">-</span>
                    {% endif %}
                  </td>
                  <td>
                    {% if checkpoint.data_entrada %}
                      {% if checkpoint.data_entrada.hour >= 6 and checkpoint.data_entrada.hour < 12 %}
                        <span style="color: #ffc107; font-weight: 500;">üåÖ Manh√£</span>
                      {% elif checkpoint.data_entrada.hour >= 12 and checkpoint.data_entrada.hour < 18 %}
                        <span style="color: #fd7e14; font-weight: 500;">‚òÄÔ∏è Tarde</span>
                      {% elif checkpoint.data_entrada.hour >= 18 and checkpoint.data_entrada.hour < 24 %}
                        <span style="color: #6f42c1; font-weight: 500;">üåô Noite</span>
                      {% else %}
                        <span style="color: #495057; font-weight: 500;">üåå Madrugada</span>
                      {% endif %}
                    {% else %}
                      <span style="color: #6c757d;">-</span>
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <div class="no-data">
            <h3>üì≠ Nenhum checkpoint encontrado</h3>
            <p>N√£o h√° registros de passagens por cercas para os filtros aplicados.</p>
            <p>Tente alterar os crit√©rios de busca ou verificar se existem dados para esta unidade.</p>
          </div>
        {% endif %}
      </div>

      

      <!-- Pagina√ß√£o -->
      {% if is_paginated %}
        <div class="pagination">
          {% if page_obj.has_previous %}
            <a href="?page=1{% if request.GET.cerca %}&cerca={{ request.GET.cerca }}{% endif %}{% if request.GET.data_inicio %}&data_inicio={{ request.GET.data_inicio }}{% endif %}{% if request.GET.data_fim %}&data_fim={{ request.GET.data_fim }}{% endif %}{% if request.GET.tipo_evento %}&tipo_evento={{ request.GET.tipo_evento }}{% endif %}">&laquo; Primeira</a>
            <a href="?page={{ page_obj.previous_page_number }}{% if request.GET.cerca %}&cerca={{ request.GET.cerca }}{% endif %}{% if request.GET.data_inicio %}&data_inicio={{ request.GET.data_inicio }}{% endif %}{% if request.GET.data_fim %}&data_fim={{ request.GET.data_fim }}{% endif %}{% if request.GET.tipo_evento %}&tipo_evento={{ request.GET.tipo_evento }}{% endif %}">‚Äπ Anterior</a>
          {% endif %}
          
          <span class="current">
            P√°gina {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
          </span>
          
          {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}{% if request.GET.cerca %}&cerca={{ request.GET.cerca }}{% endif %}{% if request.GET.data_inicio %}&data_inicio={{ request.GET.data_inicio }}{% endif %}{% if request.GET.data_fim %}&data_fim={{ request.GET.data_fim }}{% endif %}{% if request.GET.tipo_evento %}&tipo_evento={{ request.GET.tipo_evento }}{% endif %}">Pr√≥xima ‚Ä∫</a>
            <a href="?page={{ page_obj.paginator.num_pages }}{% if request.GET.cerca %}&cerca={{ request.GET.cerca }}{% endif %}{% if request.GET.data_inicio %}&data_inicio={{ request.GET.data_inicio }}{% endif %}{% if request.GET.data_fim %}&data_fim={{ request.GET.data_fim }}{% endif %}{% if request.GET.tipo_evento %}&tipo_evento={{ request.GET.tipo_evento }}{% endif %}">√öltima &raquo;</a>
          {% endif %}
        </div>
        
        <div style="text-align: center; color: #6c757d; margin: 1rem 0;">
          Mostrando {{ page_obj.start_index }} a {{ page_obj.end_index }} de {{ page_obj.paginator.count }} registros
        </div>
      {% endif %}


      <!-- Tabela Secund√°ria - Resumo por Dia -->
      <div class="daily-summary-section" style="margin-top: 3rem;">
        <div style="background: linear-gradient(135deg, #f8f9fa, #e9ecef); border-radius: 15px; padding: 2rem; border: 1px solid #dee2e6;">
          <h3 style="text-align: center; margin-bottom: 2rem; color: #2c3e50;">üìÖ Timeline de Cercas por Dia</h3>
          
          <!-- Seletor de Data -->
          <div style="display: flex; justify-content: center; align-items: center; gap: 1rem; margin-bottom: 2rem; flex-wrap: wrap;">
            <label for="data_especifica" style="font-weight: 600; color: #495057;">Selecione uma data:</label>
            <input type="date" 
                   id="data_especifica" 
                   style="padding: 0.75rem; border: 2px solid #ced4da; border-radius: 8px; background: white; color: #495057; font-size: 0.95rem;"
                   onchange="filtrarPorDiaTimeline(this.value)">
            <button onclick="limparFiltroDataTimeline()" 
                    style="padding: 0.75rem 1rem; background: linear-gradient(135deg, #6c757d 0%, #495057 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500;">
              Limpar
            </button>
          </div>

          <!-- Tabela Timeline (Cercas como Headers) -->
          <div id="daily-timeline-container" style="display: none;">
            <div style="background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.1); border: 1px solid #dee2e6;">
              <!-- Cabe√ßalho da Timeline -->
              <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1rem; text-align: center;">
                <h4 style="margin: 0; font-size: 1.1rem; font-weight: 600;">üïí Timeline de Passagens</h4>
                <p style="margin: 0.5rem 0 0 0; font-size: 0.9rem; opacity: 0.9;" id="timeline-date">Data selecionada</p>
              </div>

              <!-- Tabela com Cercas como Colunas -->
              <div style="overflow-x: auto; max-width: 100%;">
                <table style="width: 100%; min-width: 800px; border-collapse: collapse; font-size: 0.9rem;" id="timeline-table">
                  <thead style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white;">
                    <tr id="timeline-headers">
                      <th style="padding: 1rem; text-align: center; font-weight: 600; min-width: 120px; position: sticky; left: 0; background: linear-gradient(135deg, #28a745 0%, #20c997 100%); z-index: 2;">Tipo de Evento</th>
                      <!-- Cercas ser√£o adicionadas dinamicamente aqui -->
                    </tr>
                  </thead>
                  <tbody id="timeline-body">
                    <!-- Dados preenchidos via JavaScript -->
                  </tbody>
                </table>
              </div>
            </div>
            
            <!-- Legenda -->
            <div style="margin-top: 1rem; padding: 1rem; background: white; border-radius: 10px; border: 1px solid #dee2e6;">
              <h5 style="margin: 0 0 0.75rem 0; color: #495057; text-align: center;">üìã Legenda</h5>
              <div style="display: flex; justify-content: center; gap: 2rem; flex-wrap: wrap; font-size: 0.85rem;">
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                  <div style="width: 20px; height: 20px; background: linear-gradient(135deg, #d1f2eb, #a3e9d0); border: 2px solid #52c41a; border-radius: 4px;"></div>
                  <span>Entrada na Cerca</span>
                </div>
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                  <div style="width: 20px; height: 20px; background: linear-gradient(135deg, #fff2e6, #ffe0cc); border: 2px solid #fa8c16; border-radius: 4px;"></div>
                  <span>Sa√≠da da Cerca</span>
                </div>
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                  <div style="width: 20px; height: 20px; background: linear-gradient(135deg, #f8f9fa, #e9ecef); border: 2px solid #6c757d; border-radius: 4px;"></div>
                  <span>Sem Evento</span>
                </div>
              </div>
            </div>
            
            <!-- Estat√≠sticas do Dia -->
            <div id="daily-timeline-stats" style="margin-top: 1.5rem; display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem;">
              <!-- Estat√≠sticas preenchidas via JavaScript -->
            </div>
          </div>

          <!-- Mensagem quando nenhuma data est√° selecionada -->
          <div id="no-date-timeline-selected" style="text-align: center; padding: 2rem; color: #6c757d;">
            <p style="margin: 0; font-size: 1.1rem;">üìÖ Selecione uma data para ver a timeline das cercas</p>
          </div>
        </div>
      </div>

      <!-- JavaScript para funcionalidade da timeline -->
      <script>
        // Dados dos checkpoints (passados do Django)
        const checkpointsData = [
          {% for checkpoint in checkpoints %}
          {
            cerca: "{{ checkpoint.cerca|escapejs }}",
            data_entrada: "{{ checkpoint.data_entrada|date:'Y-m-d H:i:s'|default:'' }}",
            data_saida: "{{ checkpoint.data_saida|date:'Y-m-d H:i:s'|default:'' }}",
            duracao: "{{ checkpoint.duracao|default:'' }}",
            data_entrada_date: "{{ checkpoint.data_entrada|date:'Y-m-d'|default:'' }}"
          },
          {% endfor %}
        ];

        function filtrarPorDiaTimeline(dataSelecionada) {
          if (!dataSelecionada) {
            document.getElementById('daily-timeline-container').style.display = 'none';
            document.getElementById('no-date-timeline-selected').style.display = 'block';
            return;
          }

          // Filtrar checkpoints do dia selecionado
          const checkpointsDoDia = checkpointsData.filter(cp => 
            cp.data_entrada_date === dataSelecionada
          );

          if (checkpointsDoDia.length === 0) {
            document.getElementById('daily-timeline-container').style.display = 'none';
            document.getElementById('no-date-timeline-selected').innerHTML = `
              <p style="margin: 0; font-size: 1.1rem; color: #e74c3c;">
                üì≠ Nenhum checkpoint encontrado para a data ${formatarDataTimeline(dataSelecionada)}
              </p>
            `;
            document.getElementById('no-date-timeline-selected').style.display = 'block';
            return;
          }

          // Mostrar container e ocultar mensagem
          document.getElementById('daily-timeline-container').style.display = 'block';
          document.getElementById('no-date-timeline-selected').style.display = 'none';
          
          // Atualizar data no cabe√ßalho
          document.getElementById('timeline-date').textContent = formatarDataTimeline(dataSelecionada);

          // Criar lista de eventos √∫nicos (cada passagem por cerca √© um evento √∫nico)
          const eventosUnicos = [];
          checkpointsDoDia.forEach((cp, index) => {
            if (cp.data_entrada) {
              eventosUnicos.push({
                id: `evento_${index}`,
                cerca: cp.cerca,
                horario_entrada: new Date(cp.data_entrada).toTimeString().substring(0, 5),
                horario_saida: cp.data_saida ? new Date(cp.data_saida).toTimeString().substring(0, 5) : null,
                duracao: cp.duracao,
                data_entrada: cp.data_entrada,
                data_saida: cp.data_saida,
                ordem: new Date(cp.data_entrada).getTime()
              });
            }
          });

          // Ordenar eventos por hor√°rio de entrada
          eventosUnicos.sort((a, b) => a.ordem - b.ordem);
          
          // Criar headers da tabela - cada evento √© uma coluna √∫nica
          const headersRow = document.getElementById('timeline-headers');
          headersRow.innerHTML = `
            <th style="padding: 1rem; text-align: center; font-weight: 600; min-width: 120px; position: sticky; left: 0; background: linear-gradient(135deg, #28a745 0%, #20c997 100%); z-index: 2; border-right: 2px solid rgba(255,255,255,0.3);">Tipo de Evento</th>
          `;
          
          eventosUnicos.forEach((evento, index) => {
            const cercaTruncada = evento.cerca.length > 15 ? evento.cerca.substring(0, 12) + '...' : evento.cerca;
            const sequencia = eventosUnicos.filter(e => e.cerca === evento.cerca).indexOf(evento) + 1;
            const totalSequencias = eventosUnicos.filter(e => e.cerca === evento.cerca).length;
            
            const tituloColuna = totalSequencias > 1 ? 
              `${cercaTruncada} (${sequencia}/${totalSequencias})` : 
              cercaTruncada;
            
            headersRow.innerHTML += `
              <th style="padding: 1rem; text-align: center; font-weight: 600; min-width: 180px; word-break: break-word; font-size: 0.85rem;" title="${evento.cerca} - Entrada: ${evento.horario_entrada}">
                <div style="font-size: 0.9rem; font-weight: 700; margin-bottom: 0.25rem;">${tituloColuna}</div>
                <div style="font-size: 0.75rem; opacity: 0.8; font-weight: 400;">üìç ${evento.horario_entrada}</div>
              </th>
            `;
          });

          // Preencher tbody com duas linhas fixas
          const tbody = document.getElementById('timeline-body');
          tbody.innerHTML = '';

          // Linha de Entradas
          const entradaRow = document.createElement('tr');
          entradaRow.style.cssText = 'border-bottom: 1px solid #e9ecef; background: #f8f9fa;';
          
          const entradaLabelCell = document.createElement('td');
          entradaLabelCell.style.cssText = `
            padding: 1rem; 
            text-align: center; 
            font-weight: 700; 
            background: linear-gradient(135deg, #d1f2eb, #a3e9d0); 
            position: sticky; 
            left: 0; 
            border-right: 2px solid #e9ecef;
            z-index: 1;
            color: #135200;
            font-size: 1rem;
          `;
          entradaLabelCell.innerHTML = 'üü¢<br><strong>ENTRADAS</strong>';
          entradaRow.appendChild(entradaLabelCell);

          // C√©lulas de entrada para cada evento √∫nico
          eventosUnicos.forEach(evento => {
            const cell = document.createElement('td');
            cell.style.cssText = 'padding: 0.75rem; text-align: center; vertical-align: middle; min-height: 80px;';
            
            const status = !evento.data_saida ? '<div style="font-size: 0.7rem; color: #007bff; margin-top: 0.25rem;">üîÑ Em andamento</div>' : '';
            
            cell.innerHTML = `
              <div style="
                background: linear-gradient(135deg, #d1f2eb, #a3e9d0);
                border: 2px solid #52c41a;
                color: #135200;
                padding: 0.75rem;
                border-radius: 10px;
                font-size: 0.85rem;
                font-weight: 600;
                box-shadow: 0 3px 8px rgba(0,0,0,0.15);
                min-height: 60px;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
              ">
                <div style="font-size: 1.1rem; margin-bottom: 0.25rem;">‚è∞ ${evento.horario_entrada}</div>
                ${status}
              </div>
            `;
            
            entradaRow.appendChild(cell);
          });

          tbody.appendChild(entradaRow);

          // Linha do Tempo (Timeline Visual)
          const timelineRow = document.createElement('tr');
          timelineRow.style.cssText = 'height: 60px; background: linear-gradient(135deg, #f8f9fa, #e9ecef);';
          
          const timelineLabelCell = document.createElement('td');
          timelineLabelCell.style.cssText = `
            padding: 1rem; 
            text-align: center; 
            font-weight: 700; 
            background: linear-gradient(135deg, #e3f2fd, #bbdefb); 
            position: sticky; 
            left: 0; 
            border-right: 2px solid #e9ecef;
            z-index: 1;
            color: #1565c0;
            font-size: 0.9rem;
          `;
          timelineLabelCell.innerHTML = 'üìç<br><strong>TIMELINE</strong>';
          timelineRow.appendChild(timelineLabelCell);

          // C√©lulas da timeline para cada evento
          eventosUnicos.forEach((evento, index) => {
            const cell = document.createElement('td');
            cell.style.cssText = 'padding: 0.5rem; text-align: center; vertical-align: middle; position: relative;';
            
            // Calcular posi√ß√£o na timeline do dia (0-100%)
            const inicioEvento = new Date(evento.data_entrada);
            const horaInicio = inicioEvento.getHours() + inicioEvento.getMinutes() / 60;
            const porcentagemDia = (horaInicio / 24) * 100;
            
            // Dura√ß√£o visual (se houver sa√≠da)
            let duracaoVisual = '';
            let corDuracao = '#007bff';
            if (evento.horario_saida) {
              const fimEvento = new Date(evento.data_saida);
              const horaFim = fimEvento.getHours() + fimEvento.getMinutes() / 60;
              const duracaoHoras = horaFim - horaInicio;
              const larguraDuracao = Math.max(10, (duracaoHoras / 24) * 100);
              corDuracao = '#28a745';
              
              duracaoVisual = `
                <div style="
                  position: absolute;
                  bottom: 15px;
                  left: 50%;
                  transform: translateX(-50%);
                  width: ${larguraDuracao}%;
                  height: 4px;
                  background: linear-gradient(90deg, ${corDuracao}, ${corDuracao}99);
                  border-radius: 2px;
                  box-shadow: 0 1px 3px rgba(0,0,0,0.2);
                "></div>
              `;
            }
            
            cell.innerHTML = `
              <div style="
                position: relative;
                height: 40px;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
              ">
                <!-- Ponto na timeline -->
                <div style="
                  width: 12px;
                  height: 12px;
                  background: ${evento.horario_saida ? '#28a745' : '#007bff'};
                  border: 3px solid white;
                  border-radius: 50%;
                  box-shadow: 0 2px 8px rgba(0,0,0,0.2);
                  z-index: 3;
                "></div>
                
                <!-- Linha conectora (exceto no √∫ltimo) -->
                ${index < eventosUnicos.length - 1 ? `
                  <div style="
                    position: absolute;
                    top: 20px;
                    right: -50%;
                    width: 100%;
                    height: 2px;
                    background: linear-gradient(90deg, #dee2e6, #ced4da);
                    z-index: 1;
                  "></div>
                ` : ''}
                
                <!-- Indicador de sequ√™ncia -->
                <div style="
                  position: absolute;
                  top: -8px;
                  left: 50%;
                  transform: translateX(-50%);
                  background: ${evento.horario_saida ? '#28a745' : '#007bff'};
                  color: white;
                  font-size: 0.7rem;
                  font-weight: 700;
                  padding: 0.2rem 0.4rem;
                  border-radius: 10px;
                  min-width: 20px;
                  box-shadow: 0 1px 4px rgba(0,0,0,0.2);
                ">${index + 1}</div>
                
                <!-- Hor√°rio na timeline -->
                <div style="
                  position: absolute;
                  bottom: -25px;
                  left: 50%;
                  transform: translateX(-50%);
                  font-size: 0.7rem;
                  font-weight: 600;
                  color: #495057;
                  white-space: nowrap;
                ">${evento.duracao || 'Em andamento'}</div>
                
                ${duracaoVisual}
              </div>
            `;
            
            timelineRow.appendChild(cell);
          });

          tbody.appendChild(timelineRow);

          // Linha de Sa√≠das
          const saidaRow = document.createElement('tr');
          saidaRow.style.cssText = 'border-bottom: 1px solid #e9ecef; background: white;';
          
          const saidaLabelCell = document.createElement('td');
          saidaLabelCell.style.cssText = `
            padding: 1rem; 
            text-align: center; 
            font-weight: 700; 
            background: linear-gradient(135deg, #fff2e6, #ffe0cc); 
            position: sticky; 
            left: 0; 
            border-right: 2px solid #e9ecef;
            z-index: 1;
            color: #ad4e00;
            font-size: 1rem;
          `;
          saidaLabelCell.innerHTML = 'üü†<br><strong>SA√çDAS</strong>';
          saidaRow.appendChild(saidaLabelCell);

          // C√©lulas de sa√≠da para cada evento √∫nico
          eventosUnicos.forEach(evento => {
            const cell = document.createElement('td');
            cell.style.cssText = 'padding: 0.75rem; text-align: center; vertical-align: middle; min-height: 80px;';
            
            if (evento.horario_saida) {
              cell.innerHTML = `
                <div style="
                  background: linear-gradient(135deg, #fff2e6, #ffe0cc);
                  border: 2px solid #fa8c16;
                  color: #ad4e00;
                  padding: 0.75rem;
                  border-radius: 10px;
                  font-size: 0.85rem;
                  font-weight: 600;
                  box-shadow: 0 3px 8px rgba(0,0,0,0.15);
                  min-height: 60px;
                  display: flex;
                  flex-direction: column;
                  justify-content: center;
                  align-items: center;
                ">
                  <div style="font-size: 1.1rem;">‚è∞ ${evento.horario_saida}</div>
                </div>
              `;
            } else {
              cell.innerHTML = `
                <div style="
                  background: linear-gradient(135deg, #e3f2fd, #bbdefb);
                  border: 2px solid #2196f3;
                  color: #1565c0;
                  padding: 0.75rem;
                  border-radius: 10px;
                  font-size: 0.8rem;
                  font-weight: 600;
                  box-shadow: 0 3px 8px rgba(0,0,0,0.15);
                  min-height: 60px;
                  display: flex;
                  flex-direction: column;
                  justify-content: center;
                  align-items: center;
                  opacity: 0.8;
                ">
                  <div style="font-size: 1rem;">üîÑ</div>
                  <div style="font-size: 0.75rem; margin-top: 0.25rem;">Aguardando</div>
                </div>
              `;
            }
            
            saidaRow.appendChild(cell);
          });

          tbody.appendChild(saidaRow);

          // Calcular e mostrar estat√≠sticas
          const totalPassagens = eventosUnicos.length;
          const cercasUnicas = [...new Set(eventosUnicos.map(e => e.cerca))];
          const totalCercas = cercasUnicas.length;
          const totalEntradas = eventosUnicos.length;
          const totalSaidas = eventosUnicos.filter(e => e.horario_saida).length;
          const emAndamento = totalEntradas - totalSaidas;

          // Calcular estat√≠stica de cercas mais visitadas
          const visitasPorCerca = {};
          eventosUnicos.forEach(evento => {
            visitasPorCerca[evento.cerca] = (visitasPorCerca[evento.cerca] || 0) + 1;
          });
          const cercaMaisVisitada = Object.entries(visitasPorCerca).reduce((a, b) => a[1] > b[1] ? a : b);

          document.getElementById('daily-timeline-stats').innerHTML = `
            <div style="background: white; padding: 1.25rem; border-radius: 10px; text-align: center; border: 1px solid #e9ecef; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
              <div style="font-size: 1.8rem; font-weight: 700; color: #2c3e50; margin: 0.5rem 0;">${totalPassagens}</div>
              <div style="color: #6c757d; font-size: 0.85rem; font-weight: 500; text-transform: uppercase;">Eventos √önicos</div>
            </div>
            <div style="background: white; padding: 1.25rem; border-radius: 10px; text-align: center; border: 1px solid #e9ecef; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
              <div style="font-size: 1.8rem; font-weight: 700; color: #52c41a; margin: 0.5rem 0;">${totalEntradas}</div>
              <div style="color: #6c757d; font-size: 0.85rem; font-weight: 500; text-transform: uppercase;">Entradas</div>
            </div>
            <div style="background: white; padding: 1.25rem; border-radius: 10px; text-align: center; border: 1px solid #e9ecef; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
              <div style="font-size: 1.8rem; font-weight: 700; color: #fa8c16; margin: 0.5rem 0;">${totalSaidas}</div>
              <div style="color: #6c757d; font-size: 0.85rem; font-weight: 500; text-transform: uppercase;">Sa√≠das</div>
            </div>
            <div style="background: white; padding: 1.25rem; border-radius: 10px; text-align: center; border: 1px solid #e9ecef; box-shadow: 0 2px 10px rgba(0,0,0,0.05); grid-column: 1 / -1;">
              <div style="font-size: 1.2rem; font-weight: 700; color: #6f42c1; margin: 0.5rem 0;">${cercaMaisVisitada[0]}</div>
              <div style="color: #6c757d; font-size: 0.85rem; font-weight: 500; text-transform: uppercase;">Cerca Mais Visitada (${cercaMaisVisitada[1]}x)</div>
            </div>
          `;
        }

        function limparFiltroDataTimeline() {
          document.getElementById('data_especifica').value = '';
          document.getElementById('daily-timeline-container').style.display = 'none';
          document.getElementById('no-date-timeline-selected').style.display = 'block';
          document.getElementById('no-date-timeline-selected').innerHTML = `
            <p style="margin: 0; font-size: 1.1rem;">üìÖ Selecione uma data para ver a timeline das cercas</p>
          `;
        }

        function formatarDataTimeline(dataString) {
          const data = new Date(dataString);
          const opcoes = { 
            weekday: 'long', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
          };
          return data.toLocaleDateString('pt-BR', opcoes);
        }

        // Definir data de hoje como padr√£o
        document.addEventListener('DOMContentLoaded', function() {
          const hoje = new Date().toISOString().split('T')[0];
          document.getElementById('data_especifica').value = hoje;
          filtrarPorDiaTimeline(hoje);
        });
      </script>

    </main>

    <footer class="footer">
      <p>&copy; 2025 Umbrella360. CheckPoints - {{ unidade.nm|default:unidade.id }}</p>
      <p><em>"Rastreamento completo e transparente de cada movimento"</em></p>
    </footer>
  </body>
</html>
